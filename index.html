<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Idea Share App</title>
<style>
:root {
  --primary: #4f46e5;
  --primary-light: hsl(239, 84%, 67%);
  --primary-dark: #4338ca;
  --background: #f9fafb;
  --card-bg: #ffffff;
  --text-primary: #1f2937;
  --text-secondary: #4b5563;
  --accent: #4338ca;
  --shadow-color: rgba(79, 70, 229, 0.3);
  --button-bg: var(--accent);
  --button-bg-hover: #4338ca;
  --button-shadow: #2a228a;
}

* { box-sizing: border-box; transition: background-color .3s ease, color .3s ease; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 650px; margin: 2rem auto; padding: 1rem 1.5rem; background: var(--background); color: var(--text-primary); }
h1 { text-align:center; margin-bottom:1rem; color:var(--button-bg); font-weight:700; font-size:2.4rem; letter-spacing:.05em; user-select:none; cursor:default; text-shadow:0 2px 6px var(--button-shadow); }

#adminPanel { display:none; margin:1rem 0 1.5rem 0; padding:.9rem 1rem; border-radius:12px; background:#eef2ff; border:2px dashed var(--primary-dark); box-shadow:0 6px 16px rgba(0,0,0,.06); }
#adminPanel h3 { margin:0 0 .5rem 0; }
.adminRow { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
.adminBadge { font-size:.9rem; color:var(--text-secondary); }

button { background: var(--button-bg); border:none; color:white; padding:0.6rem 1.0rem; font-size:1rem; font-weight:600; border-radius:8px; cursor:pointer; box-shadow:0 6px 12px var(--button-shadow); user-select:none; outline-offset:4px; outline-color:transparent; outline-style:solid; transition:background .3s ease, box-shadow .3s ease, transform .15s ease, outline-color .3s ease; display:inline-block; margin:0.25rem 0; }
button:hover { background: var(--button-bg-hover); box-shadow:0 8px 20px var(--button-shadow); transform:translateY(-2px); outline-color: var(--accent); }
button:active { transform:translateY(1px); box-shadow:0 4px 10px var(--button-shadow); }
.danger { background: #dc2626; }
.danger:hover { background:#b91c1c; }
.secondary { background: #6b7280; }
.secondary:hover { background: #4b5563; }

input, textarea { width:100%; padding:.6rem .9rem; margin:.5rem 0 1rem 0; border-radius:8px; border:2px solid #d1d5db; font-size:1rem; font-weight:500; color: var(--text-primary); background:white; transition:border-color .3s ease; resize: vertical; font-family:inherit; }
input:focus, textarea:focus { border-color: var(--primary); outline:none; box-shadow:0 0 6px var(--primary-light); }

#ideaForm { margin-bottom:2rem; background:var(--card-bg); padding:1.4rem 1.6rem; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.08); animation:fadeIn .8s ease forwards; }
#ideasList { display:flex; flex-direction:column; gap:1.2rem; }
.card { position:relative; background:var(--card-bg); padding:1.2rem 1.6rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); opacity:0; transform:translateY(15px); animation:fadeInUp .5s ease forwards; transition: box-shadow .3s ease; }
.card:hover { box-shadow:0 8px 24px rgba(0,0,0,0.12); }
.card h3 { margin:0 0 .3rem 0; font-weight:700; color:var(--primary-dark); }

.posted-time { font-size:.85rem; color:var(--text-secondary); margin-bottom:.5rem; }
.author { margin-bottom:.7rem; display:flex; align-items:center; gap:.5rem; color:var(--text-secondary); font-weight:600; }
.author img { width:28px; height:28px; border-radius:50%; box-shadow:0 0 4px var(--primary-light); cursor:pointer; transition: transform .2s ease; }
.author img:hover { transform: scale(1.1); }
.author span { cursor:pointer; transition: color .2s ease; }
.author span:hover { color: var(--primary); }
.devBadge { background:#facc15; color:#1f2937; font-size:.75rem; font-weight:700; padding:0 6px; border-radius:6px; margin-left:4px; }
.markdown-body { color: var(--text-primary); line-height:1.5; margin-bottom:1rem; font-weight:500; font-size:1rem; user-select:text; white-space:pre-wrap; }

.reactBtn { margin-bottom:.5rem; font-weight:700; font-size:1.05rem; padding:.45rem .95rem; border-radius:24px; color:white; user-select:none; display:inline-flex; align-items:center; gap:6px; background:var(--button-bg); box-shadow:0 6px 12px var(--button-shadow); border:none; }
.reactionMenu { position:absolute; bottom:100%; left:0; display:none; gap:8px; padding:.3rem .6rem; border-radius:30px; background:var(--card-bg); box-shadow:0 4px 16px rgba(0,0,0,.15); user-select:none; z-index:1000; white-space:nowrap; flex-wrap:wrap; }
.reactionMenu button { background:transparent; border:none; font-size:1.5rem; cursor:pointer; padding:0 6px; transition: transform .15s ease; color:var(--text-primary); }
.reactionMenu button:hover { transform:scale(1.3); }

 .reactionsDisplay { margin-top:6px; font-size:1.2rem; user-select:none; color:var(--accent); min-height:1.4rem; }
 .comments { font-size:.95rem; color:var(--text-secondary); user-select:text; }
.comment { margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem; line-height:1.3; }
.comment img { width:22px; height:22px; border-radius:50%; box-shadow:0 0 3px var(--primary-light); cursor:pointer; }
.comment .comment-text { display:inline-block; word-break:break-word; }
.comment-author { cursor:pointer; font-weight:600; transition: color .2s ease; }
.comment-author:hover { color: var(--primary); }

#authButtons { display:flex; justify-content:center; gap:1rem; margin-bottom:1rem; }
#customization { display:flex; justify-content:center; gap:1.5rem; margin-bottom:1.2rem; flex-wrap:wrap; font-weight:600; color:var(--text-secondary); }
#customization input[type="color"] { margin-top:.3rem; width:40px; height:30px; border:none; cursor:pointer; border-radius:6px; box-shadow:0 0 5px rgba(0,0,0,.1); }

/* Profile Modal Styles - CRITICAL FIX */
#profileModal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center; padding:1rem; }
#profileModal.active { display:flex !important; }
#profileContent { background:var(--card-bg); border-radius:16px; padding:2rem; max-width:500px; width:100%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); position:relative; animation:fadeInUp .3s ease; }
#closeProfile { position:absolute; top:1rem; right:1rem; background:transparent; border:none; font-size:2rem; color:var(--text-secondary); cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:background .2s ease; line-height:1; padding:0; }
#closeProfile:hover { background:#f3f4f6; }
.profile-header { display:flex; gap:1.5rem; margin-bottom:1.5rem; align-items:flex-start; }
.profile-avatar-large { width:80px; height:80px; border-radius:50%; box-shadow:0 4px 12px rgba(0,0,0,0.15); object-fit:cover; flex-shrink:0; }
.profile-info { flex:1; min-width:0; }
.profile-name { font-size:1.5rem; font-weight:700; margin-bottom:.5rem; color:var(--text-primary); display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
.profile-bio { color:var(--text-secondary); line-height:1.6; margin-bottom:1rem; white-space:pre-wrap; word-wrap:break-word; }
.profile-stats { display:flex; gap:1.5rem; margin-bottom:1rem; }
.profile-stat { text-align:center; }
.profile-stat-value { font-size:1.2rem; font-weight:700; color:var(--primary-dark); }
 .profile-stat-label { font-size:.85rem; color:var(--text-secondary); }
 .profile-stat:hover { transform:scale(1.05); }
 .profile-actions { display:flex; gap:.5rem; margin-top:.5rem; flex-wrap:wrap; }
 
 /* Followers/Following Modal */
 .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2001; align-items:center; justify-content:center; padding:1rem; }
 .modal.active { display:flex !important; }
 .modal-content { background:var(--card-bg); border-radius:16px; padding:1.5rem; max-width:400px; width:100%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:fadeInUp .3s ease; }
 .follower-item { display:flex; align-items:center; gap:1rem; padding:.75rem; border-radius:8px; margin-bottom:.5rem; transition:background .2s ease; cursor:pointer; }
 .follower-item:hover { background:#f3f4f6; }
 .follower-item img { width:40px; height:40px; border-radius:50%; object-fit:cover; }
 .follower-item-info { flex:1; }
 .follower-item-name { font-weight:600; color:var(--primary-dark); margin:0; }
 .follower-item-bio { font-size:.85rem; color:var(--text-secondary); margin:.25rem 0 0 0; }
#profileIdeasList { margin-top:1.5rem; }
.profile-idea-card { background:#f9fafb; padding:1rem; border-radius:8px; margin-bottom:.75rem; }
.profile-idea-card h4 { margin:0 0 .5rem 0; color:var(--primary-dark); font-size:1rem; }
.profile-idea-card .idea-time { font-size:.75rem; color:var(--text-secondary); }

 /* Navigation */
 #navBar { 
   display:flex; 
   flex-direction:column;
   gap:.5rem; 
   position:fixed; 
   top:50%; 
   left:1.5rem; 
   transform:translateY(-50%);
   z-index:1000;
   background:linear-gradient(135deg, var(--card-bg) 0%, rgba(255,255,255,0.95) 100%);
   padding:1.25rem 1rem;
   border-radius:16px;
   box-shadow:0 8px 32px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08);
   border:1px solid rgba(79, 70, 229, 0.2);
   backdrop-filter:blur(10px);
 }
 .nav-link { 
   background:rgba(79, 70, 229, 0.05); 
   border:2px solid transparent; 
   color:var(--primary-dark); 
   padding:.85rem 1.5rem; 
   transition:all .3s cubic-bezier(0.4, 0, 0.2, 1); 
   border-radius:10px;
   white-space:nowrap;
   min-width:140px;
   text-align:center;
   font-weight:600;
   font-size:0.95rem;
   cursor:pointer;
   position:relative;
   overflow:hidden;
 }
 .nav-link::before {
   content:'';
   position:absolute;
   left:0;
   top:0;
   width:4px;
   height:100%;
   background:var(--primary);
   transform:scaleY(0);
   transition:transform .3s ease;
 }
 .nav-link:hover { 
   background:rgba(79, 70, 229, 0.1); 
   color:var(--primary-dark);
   transform:translateX(5px);
   border-color:rgba(79, 70, 229, 0.3);
   box-shadow:0 4px 12px rgba(79, 70, 229, 0.15);
 }
 .nav-link:hover::before {
   transform:scaleY(1);
 }
 .nav-link.active { 
   background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
   color:white;
   box-shadow:0 4px 16px var(--button-shadow), inset 0 1px 0 rgba(255,255,255,0.2);
   border-color:var(--primary-dark);
   transform:translateX(3px);
 }
 .nav-link.active::before {
   transform:scaleY(1);
   background:white;
   width:4px;
 }

@keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
@keyframes fadeInUp { from {opacity:0; transform: translateY(15px);} to {opacity:1; transform: translateY(0);} }

@media (max-width: 900px) {
  #navBar { 
    left: 0.5rem; 
    padding: 1rem 0.75rem;
    transform: translateY(-50%) scale(0.9);
  }
  .nav-link { 
    padding: 0.7rem 1.2rem;
    min-width: 110px;
    font-size: 0.85rem;
  }
}
</style>
</head>
<body>

<h1>The Idea App</h1>

<section id="adminPanel">
  <h3>ðŸ”’ Admin Panel</h3>
  <div class="adminRow">
    <span class="adminBadge" id="adminUidBadge">UID: â€”</span>
    <button id="deleteAllBtn" class="danger">Delete ALL Ideas</button>
  </div>
  <small style="color:#6b7280;">Only visible to your admin account. Actions are immediate.</small>
</section>

<div id="authButtons">
  <button id="signInBtn">Sign In with Google</button>
  <button id="signOutBtn" style="display:none;">Sign Out</button>
</div>

<div id="navBar" style="display:none;">
  <button class="nav-link active" id="navIdeas">Ideas</button>
  <button class="nav-link" id="navProfile">My Profile</button>
</div>

 <div id="customization">
   <label>Background Color: <input type="color" id="bgColorPicker" value="#f9fafb"></label>
   <label>Button Color: <input type="color" id="btnColorPicker" value="#4f46e5"></label>
 </div>

<div id="ideaForm" style="display:none;">
  <input id="ideaTitle" placeholder="Idea Title" />
  <textarea id="ideaDesc" rows="4" placeholder="Describe your idea in markdown..."></textarea>
  <button id="postIdea">Post Idea</button>
</div>

<div id="sortOptions" style="margin-bottom:1rem; text-align:center;">
  <label for="sortSelect">Sort by: </label>
  <select id="sortSelect">
    <option value="newest">Newest</option>
    <option value="mostReactions">Most Reactions</option>
    <option value="mostComments">Most Comments</option>
  </select>
</div>

<div id="ideasList"></div>

<!-- Profile Modal -->
<div id="profileModal">
  <div id="profileContent">
    <button id="closeProfile">Ã—</button>
    <div id="profileView">
      <div class="profile-header">
        <img id="profileAvatar" class="profile-avatar-large" src="" alt="Profile" />
        <div class="profile-info">
          <div class="profile-name" id="profileName">Loading...</div>
          <div class="profile-bio" id="profileBio">No bio yet.</div>
          <div class="profile-stats">
            <div class="profile-stat">
              <div class="profile-stat-value" id="profileIdeasCount">0</div>
              <div class="profile-stat-label">Ideas</div>
            </div>
            <div class="profile-stat" id="followersStat" style="cursor:pointer; transition:transform .2s;">
              <div class="profile-stat-value" id="profileFollowersCount">0</div>
              <div class="profile-stat-label">Followers</div>
            </div>
            <div class="profile-stat" id="followingStat" style="cursor:pointer; transition:transform .2s;">
              <div class="profile-stat-value" id="profileFollowingCount">0</div>
              <div class="profile-stat-label">Following</div>
            </div>
          </div>
          <div class="profile-actions" id="profileActions"></div>
        </div>
      </div>
      <div id="profileIdeasList"></div>
    </div>
    <div id="profileEdit" style="display:none;">
      <h3>Edit Profile</h3>
      <label>Bio:</label>
      <textarea id="profileBioEdit" placeholder="Tell us about yourself..." style="min-height:80px;"></textarea>
      <button id="saveProfileBtn">Save Profile</button>
      <button class="secondary" id="cancelEditBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Followers/Following Modal -->
<div id="followersModal" class="modal">
  <div class="modal-content" style="max-width:400px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
      <h3 id="followersModalTitle" style="margin:0; color:var(--primary-dark);">Followers</h3>
      <button id="closeFollowersModal" class="button secondary" style="padding:.4rem .8rem;">âœ•</button>
    </div>
    <div id="followersList" style="max-height:400px; overflow-y:auto;">
      <!-- Follower/following users will be loaded here -->
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, arrayUnion, arrayRemove, deleteDoc, getDocs, getDoc, setDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAu2x0HdXxGiLv1Rhjqwv4Lkp2Wooo13L0",
  authDomain: "theideaapp-2ff99.firebaseapp.com",
  projectId: "theideaapp-2ff99",
  storageBucket: "theideaapp-2ff99.firebasestorage.app",
  messagingSenderId: "964418361365",
  appId: "1:964418361365:web:44fd66314e75b4181e561c",
  measurementId: "G-FJQ0228EZK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt: 'select_account' });

const ADMIN_UID = "x7GUnYJAeGg4qx68iZfT0Ns46EC3";
let isAdmin = false;
let currentUserProfile = null;
let viewingProfileUid = null;

// Get all DOM elements
const adminPanel = document.getElementById("adminPanel");
const adminUidBadge = document.getElementById("adminUidBadge");
const deleteAllBtn = document.getElementById("deleteAllBtn");
const ideasList = document.getElementById("ideasList");
const postBtn = document.getElementById("postIdea");
const ideaTitle = document.getElementById("ideaTitle");
const ideaDesc = document.getElementById("ideaDesc");
const signInBtn = document.getElementById("signInBtn");
const signOutBtn = document.getElementById("signOutBtn");
const ideaForm = document.getElementById("ideaForm");
const bgColorPicker = document.getElementById("bgColorPicker");
const btnColorPicker = document.getElementById("btnColorPicker");
const profileModal = document.getElementById("profileModal");
const closeProfile = document.getElementById("closeProfile");
const navBar = document.getElementById("navBar");
const navIdeas = document.getElementById("navIdeas");
const navProfile = document.getElementById("navProfile");
const profileEdit = document.getElementById("profileEdit");
const profileBioEdit = document.getElementById("profileBioEdit");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const followersModal = document.getElementById("followersModal");
const closeFollowersModal = document.getElementById("closeFollowersModal");
const followersList = document.getElementById("followersList");
const followersModalTitle = document.getElementById("followersModalTitle");
const followersStat = document.getElementById("followersStat");
const followingStat = document.getElementById("followingStat");

 // ---------------- Customization ----------------
 // Load saved colors from localStorage on page load
 const savedBgColor = localStorage.getItem("ideaApp_bgColor");
 const savedBtnColor = localStorage.getItem("ideaApp_btnColor");
 if (savedBgColor) {
   document.body.style.backgroundColor = savedBgColor;
   bgColorPicker.value = savedBgColor;
 }
 if (savedBtnColor) {
   applyButtonColor(savedBtnColor);
   btnColorPicker.value = savedBtnColor;
 }

 function applyButtonColor(val) {
   document.documentElement.style.setProperty("--accent", val);
   document.documentElement.style.setProperty("--button-bg", val);
   document.documentElement.style.setProperty("--primary", val);
   document.documentElement.style.setProperty("--primary-dark", shadeColor(val, -15));
   document.documentElement.style.setProperty("--button-bg-hover", shadeColor(val, -20));
   document.documentElement.style.setProperty("--button-shadow", hexToRgba(val, 0.4));
   document.documentElement.style.setProperty("--shadow-color", hexToRgba(val, 0.3));
 }

 bgColorPicker.addEventListener("input", e => { 
   const color = e.target.value;
   document.body.style.backgroundColor = color;
   localStorage.setItem("ideaApp_bgColor", color);
 });

 btnColorPicker.addEventListener("input", e => {
   const val = e.target.value;
   applyButtonColor(val);
   localStorage.setItem("ideaApp_btnColor", val);
 });
function shadeColor(color, percent) {
  let R = parseInt(color.substring(1,3),16), G = parseInt(color.substring(3,5),16), B = parseInt(color.substring(5,7),16);
  R = Math.min(255, Math.max(0, parseInt(R*(100+percent)/100)));
  G = Math.min(255, Math.max(0, parseInt(G*(100+percent)/100)));
  B = Math.min(255, Math.max(0, parseInt(B*(100+percent)/100)));
  return "#" + [R,G,B].map(v=>v.toString(16).padStart(2,"0")).join("");
}
function hexToRgba(hex,a){ const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }

// ---------------- Profile Functions ----------------
async function getOrCreateProfile(uid, displayName, photoURL) {
  const profileRef = doc(db, "profiles", uid);
  let profileSnap;
  try {
    profileSnap = await getDoc(profileRef);
  } catch (err) {
    if (err.code === 'permission-denied') {
      console.error("Permission denied reading profile:", err);
      throw err;
    }
    throw err;
  }
  
  if (!profileSnap.exists()) {
    try {
      await setDoc(profileRef, {
        uid,
        displayName,
        photoURL,
        bio: "",
        followers: [],
        following: [],
        createdAt: serverTimestamp()
      });
    } catch (err) {
      if (err.code === 'permission-denied') {
        console.error("Permission denied creating profile:", err);
        throw err;
      }
      throw err;
    }
  } else {
    try {
      await updateDoc(profileRef, {
        displayName,
        photoURL
      });
    } catch (err) {
      if (err.code === 'permission-denied') {
        console.error("Permission denied updating profile:", err);
        throw err;
      }
      throw err;
    }
  }
  const updatedSnap = await getDoc(profileRef);
  return updatedSnap.data();
}

async function followUser(targetUid) {
  if (!auth.currentUser || targetUid === auth.currentUser.uid) return;
  const userUid = auth.currentUser.uid;
  const userProfileRef = doc(db, "profiles", userUid);
  const targetProfileRef = doc(db, "profiles", targetUid);
  
  try {
    // First, ensure both profiles exist
    const userProfile = await getDoc(userProfileRef);
    const targetProfile = await getDoc(targetProfileRef);
    
    if (!userProfile.exists()) {
      // Create user profile if it doesn't exist
      await getOrCreateProfile(userUid, auth.currentUser.displayName, auth.currentUser.photoURL);
    }
    
    if (!targetProfile.exists()) {
      alert("The profile you're trying to follow doesn't exist.");
      return;
    }
    
    const userFollowing = (await getDoc(userProfileRef)).data()?.following || [];
    const isFollowing = userFollowing.includes(targetUid);
    
    // Update current user's following list (this should always work)
    try {
      if (isFollowing) {
        await updateDoc(userProfileRef, { following: arrayRemove(targetUid) });
      } else {
        await updateDoc(userProfileRef, { following: arrayUnion(targetUid) });
      }
    } catch (err) {
      console.error("Error updating own following list:", err);
      alert("Error updating your following list: " + err.message);
      return;
    }
    
    // Update target user's followers list (this might fail due to permissions)
    try {
      if (isFollowing) {
        await updateDoc(targetProfileRef, { followers: arrayRemove(userUid) });
      } else {
        await updateDoc(targetProfileRef, { followers: arrayUnion(userUid) });
      }
    } catch (err) {
      console.error("Error updating target followers list:", err);
      if (err.code === 'permission-denied') {
        alert("Permission denied: Cannot update follower count. Please check Firestore security rules to allow updating the 'followers' field on profiles.");
      } else {
        alert("Error updating follower count: " + err.message);
      }
      // Still update current user's profile even if target update fails
    }
    
    await refreshCurrentUserProfile();
  } catch (err) {
    console.error("Error following user:", err);
    if (err.code === 'permission-denied') {
      alert("Permission denied. Please check Firestore security rules. The rules need to allow:\n1. Users to update their own 'following' array\n2. Users to update any profile's 'followers' array");
    } else {
      alert("Error: " + err.message);
    }
  }
}

async function loadFollowersList(uid, type) {
  if (!uid) {
    console.error("No UID provided to loadFollowersList");
    alert("Error: No user ID provided");
    return;
  }
  
  if (!followersList || !followersModalTitle || !followersModal) {
    console.error("Followers modal elements not found");
    alert("Error: Page elements not loaded");
    return;
  }
  
  try {
    // Show loading state
    followersModalTitle.textContent = type === "followers" ? "Followers" : "Following";
    followersList.innerHTML = "<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>Loading...</p>";
    followersModal.classList.add("active");
    
    // Get the profile to access followers/following arrays
    const profileRef = doc(db, "profiles", uid);
    const profileSnap = await getDoc(profileRef);
    
    if (!profileSnap.exists()) {
      followersList.innerHTML = "<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>Profile not found.</p>";
      return;
    }
    
    const profile = profileSnap.data();
    const userIds = type === "followers" ? (profile.followers || []) : (profile.following || []);
    
    if (!Array.isArray(userIds)) {
      followersList.innerHTML = `<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>No ${type} yet.</p>`;
      return;
    }
    
    if (userIds.length === 0) {
      followersList.innerHTML = `<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>No ${type} yet.</p>`;
      return;
    }
    
    // Clear the list
    followersList.innerHTML = "";
    
    // Load each user's profile
    const userPromises = userIds.map(async (userId) => {
      if (!userId || typeof userId !== 'string') {
        return null;
      }
      try {
        const userProfileRef = doc(db, "profiles", userId);
        const userProfileSnap = await getDoc(userProfileRef);
        if (userProfileSnap.exists()) {
          const data = userProfileSnap.data();
          return { ...data, uid: userId }; // Ensure uid is included
        }
        return null;
      } catch (err) {
        console.error("Error loading user profile for userId:", userId, err);
        return null;
      }
    });
    
    const userProfiles = (await Promise.all(userPromises)).filter(p => p !== null && p.uid);
    
    if (userProfiles.length === 0) {
      followersList.innerHTML = `<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>No ${type} profiles found.</p>`;
      return;
    }
    
    // Display each user
    userProfiles.forEach(userProfile => {
      if (!userProfile.uid) return; // Skip if no uid
      
      const item = document.createElement("div");
      item.className = "follower-item";
      item.addEventListener("click", () => {
        followersModal.classList.remove("active");
        loadProfile(userProfile.uid);
      });
      
      const avatar = document.createElement("img");
      avatar.src = userProfile.photoURL || "https://ui-avatars.com/api/?name=" + encodeURIComponent(userProfile.displayName || "User") + "&background=4f46e5&color=fff";
      avatar.alt = userProfile.displayName || "User";
      avatar.onerror = () => { avatar.src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(userProfile.displayName || "User") + "&background=4f46e5&color=fff"; };
      
      const info = document.createElement("div");
      info.className = "follower-item-info";
      
      const name = document.createElement("div");
      name.className = "follower-item-name";
      name.textContent = userProfile.displayName || "Unknown User";
      
      const bio = document.createElement("div");
      bio.className = "follower-item-bio";
      bio.textContent = (userProfile.bio || "").substring(0, 100) || "No bio yet.";
      if (userProfile.bio && userProfile.bio.length > 100) {
        bio.textContent += "...";
      }
      
      info.appendChild(name);
      info.appendChild(bio);
      item.appendChild(avatar);
      item.appendChild(info);
      followersList.appendChild(item);
    });
  } catch (err) {
    console.error("Error loading followers/following:", err);
    const errorMsg = err.message || "Unknown error occurred";
    followersList.innerHTML = `<p style='text-align:center; color:#dc2626; padding:2rem;'>Error loading ${type}: ${errorMsg}</p>`;
  }
}

async function loadProfile(uid) {
  if (!uid) {
    console.error("No UID provided to loadProfile");
    alert("No user ID provided");
    return;
  }
  
  console.log("Loading profile for UID:", uid);
  viewingProfileUid = uid;
  
  try {
    let profileRef = doc(db, "profiles", uid);
    let profileSnap;
    
    try {
      profileSnap = await getDoc(profileRef);
    } catch (err) {
      if (err.code === 'permission-denied') {
        alert("Permission denied. Please check Firestore security rules. Profiles collection needs read access.");
        console.error("Firestore permission error:", err);
        return;
      }
      throw err;
    }
    
    if (!profileSnap.exists()) {
      const user = auth.currentUser;
      if (user && user.uid === uid) {
        try {
          await getOrCreateProfile(uid, user.displayName, user.photoURL);
          profileSnap = await getDoc(profileRef);
        } catch (err) {
          if (err.code === 'permission-denied') {
            alert("Permission denied. Cannot create profile. Please check Firestore security rules.");
            console.error("Firestore permission error:", err);
            return;
          }
          throw err;
        }
      } else {
        try {
          await setDoc(profileRef, {
            uid,
            displayName: "User",
            photoURL: "",
            bio: "",
            followers: [],
            following: [],
            createdAt: serverTimestamp()
          });
          profileSnap = await getDoc(profileRef);
        } catch (err) {
          if (err.code === 'permission-denied') {
            alert("Permission denied. Cannot create profile. Please check Firestore security rules.");
            console.error("Firestore permission error:", err);
            return;
          }
          throw err;
        }
      }
    }
    
    const profile = profileSnap.data();
    console.log("Profile loaded:", profile);
    
    // Get user's ideas
    let userIdeas = [];
    try {
      const ideasQuery = query(collection(db, "ideas"), where("uid", "==", uid), orderBy("created", "desc"));
      const ideasSnapshot = await getDocs(ideasQuery);
      userIdeas = ideasSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (err) {
      console.warn("Query failed, filtering manually:", err);
      const allIdeasSnap = await getDocs(collection(db, "ideas"));
      userIdeas = allIdeasSnap.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .filter(idea => idea.uid === uid)
        .sort((a, b) => {
          const aDate = a.created?.toDate ? a.created.toDate() : new Date(a.created);
          const bDate = b.created?.toDate ? b.created.toDate() : new Date(b.created);
          return bDate - aDate;
        });
    }
    
    // Update profile modal UI
    const profileNameEl = document.getElementById("profileName");
    profileNameEl.innerHTML = profile.displayName || "Anonymous";
    
    const existingBadge = profileNameEl.querySelector(".devBadge");
    if (profile.uid === ADMIN_UID) {
      if (!existingBadge) {
        const badge = document.createElement("span");
        badge.className = "devBadge";
        badge.textContent = "Developer";
        badge.style.marginLeft = "8px";
        profileNameEl.appendChild(badge);
      }
    } else if (existingBadge) {
      existingBadge.remove();
    }
    
    document.getElementById("profileAvatar").src = profile.photoURL || "https://www.gravatar.com/avatar?d=mp&f=y";
    document.getElementById("profileBio").textContent = profile.bio || "No bio yet.";
    document.getElementById("profileIdeasCount").textContent = userIdeas.length;
    document.getElementById("profileFollowersCount").textContent = (profile.followers || []).length;
    document.getElementById("profileFollowingCount").textContent = (profile.following || []).length;
    
    // Profile actions
    const actionsDiv = document.getElementById("profileActions");
    actionsDiv.innerHTML = "";
    
    if (auth.currentUser && uid === auth.currentUser.uid) {
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit Profile";
      editBtn.onclick = () => {
        document.getElementById("profileView").style.display = "none";
        profileEdit.style.display = "block";
        profileBioEdit.value = profile.bio || "";
      };
      actionsDiv.appendChild(editBtn);
    } else if (auth.currentUser) {
      const isFollowing = (currentUserProfile?.following || []).includes(uid);
      const followBtn = document.createElement("button");
      followBtn.textContent = isFollowing ? "Following" : "Follow";
      followBtn.className = isFollowing ? "secondary" : "";
      followBtn.onclick = async () => {
        await followUser(uid);
        await loadProfile(uid);
      };
      actionsDiv.appendChild(followBtn);
    }
    
    // Render user's ideas
    const ideasListDiv = document.getElementById("profileIdeasList");
    ideasListDiv.innerHTML = "";
    if (userIdeas.length === 0) {
      ideasListDiv.innerHTML = "<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>No ideas yet.</p>";
    } else {
      userIdeas.forEach(idea => {
        const ideaCard = document.createElement("div");
        ideaCard.className = "profile-idea-card";
        ideaCard.innerHTML = `
          <h4>${escapeHtml(idea.title || "")}</h4>
          <div class="markdown-body" style="font-size:0.9rem; margin-bottom:0.5rem;">${markdownToHTML(idea.description || "")}</div>
          <div class="idea-time">${formatDate(idea.created)}</div>
        `;
        ideasListDiv.appendChild(ideaCard);
      });
    }
    
    // Show the modal - THIS IS THE KEY FIX
    console.log("Showing modal");
    profileModal.classList.add("active");
    console.log("Modal classes:", profileModal.className);
  } catch (err) {
    console.error("Error loading profile:", err);
    alert("Error loading profile: " + err.message);
  }
}

function escapeHtml(text) {
  if (!text) return "";
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function refreshCurrentUserProfile() {
  if (auth.currentUser) {
    try {
      currentUserProfile = await getOrCreateProfile(
        auth.currentUser.uid,
        auth.currentUser.displayName,
        auth.currentUser.photoURL
      );
      const profileSnap = await getDoc(doc(db, "profiles", auth.currentUser.uid));
      if (profileSnap.exists()) {
        currentUserProfile = profileSnap.data();
      }
    } catch (err) {
      console.error("Error refreshing profile:", err);
    }
  }
}

// Profile modal event handlers - CRITICAL FIXES
closeProfile.addEventListener("click", () => {
  profileModal.classList.remove("active");
  document.getElementById("profileView").style.display = "block";
  profileEdit.style.display = "none";
});

profileModal.addEventListener("click", (e) => {
  if (e.target === profileModal) {
    profileModal.classList.remove("active");
    document.getElementById("profileView").style.display = "block";
    profileEdit.style.display = "none";
  }
});

saveProfileBtn.addEventListener("click", async () => {
  if (!auth.currentUser) return;
  try {
    const bio = profileBioEdit.value.trim();
    await updateDoc(doc(db, "profiles", auth.currentUser.uid), { bio });
    profileEdit.style.display = "none";
    document.getElementById("profileView").style.display = "block";
    await loadProfile(auth.currentUser.uid);
  } catch (err) {
    alert("Error saving profile: " + err.message);
  }
});

cancelEditBtn.addEventListener("click", () => {
  profileEdit.style.display = "none";
  document.getElementById("profileView").style.display = "block";
});

// Followers/Following event listeners
followersStat.addEventListener("click", () => {
  if (viewingProfileUid) {
    loadFollowersList(viewingProfileUid, "followers");
  }
});

followingStat.addEventListener("click", () => {
  if (viewingProfileUid) {
    loadFollowersList(viewingProfileUid, "following");
  }
});

closeFollowersModal.addEventListener("click", () => {
  followersModal.classList.remove("active");
});

followersModal.addEventListener("click", (e) => {
  if (e.target === followersModal) {
    followersModal.classList.remove("active");
  }
});

// Navigation handlers - CRITICAL FIXES
navIdeas.addEventListener("click", () => {
  console.log("Ideas nav clicked");
  navIdeas.classList.add("active");
  navProfile.classList.remove("active");
  document.getElementById("sortOptions").style.display = "block";
  document.getElementById("ideasList").style.display = "flex";
  profileModal.classList.remove("active");
});

navProfile.addEventListener("click", async () => {
  console.log("Profile nav clicked");
  if (!auth.currentUser) {
    alert("Please sign in to view your profile");
    return;
  }
  navIdeas.classList.remove("active");
  navProfile.classList.add("active");
  document.getElementById("sortOptions").style.display = "none";
  document.getElementById("ideasList").style.display = "none";
  console.log("Loading profile for user:", auth.currentUser.uid);
  await loadProfile(auth.currentUser.uid);
});

// ---------------- Auth ----------------
signInBtn.addEventListener("click", async ()=>{ 
  try{ 
    await signInWithPopup(auth, provider); 
  } catch(e){ 
    alert("Sign-in failed: "+e.message); 
  } 
});

signOutBtn.addEventListener("click", async ()=>{ 
  try{ 
    await signOut(auth); 
    profileModal.classList.remove("active");
  } catch(e){ 
    alert("Sign-out failed: "+e.message); 
  } 
});

onAuthStateChanged(auth, async user=>{
  if(user){
    signInBtn.style.display="none"; 
    signOutBtn.style.display="inline-block"; 
    ideaForm.style.display="block"; 
    navBar.style.display="flex";
    isAdmin = (user.uid === ADMIN_UID);
    adminPanel.style.display = isAdmin ? "block":"none";
    adminUidBadge.textContent = "UID: "+user.uid;
    await getOrCreateProfile(user.uid, user.displayName, user.photoURL);
    await refreshCurrentUserProfile();
    renderAllIdeas();
  } else {
    signInBtn.style.display="inline-block"; 
    signOutBtn.style.display="none"; 
    ideaForm.style.display="none"; 
    navBar.style.display="none";
    isAdmin=false; 
    adminPanel.style.display="none";
    currentUserProfile = null;
    renderAllIdeas();
  }
});

// ---------------- Admin Actions ----------------
deleteAllBtn.addEventListener("click", async ()=>{
  if(!isAdmin) return;
  if(!confirm("âš ï¸ Delete ALL ideas?")) return;
  try{
    const qsnap = await getDocs(collection(db,"ideas"));
    const ops = []; qsnap.forEach(d=>ops.push(deleteDoc(doc(db,"ideas",d.id))));
    await Promise.all(ops);
    alert("All ideas deleted.");
  }catch(err){ alert("Error deleting all ideas: "+err.message); }
});

// ---------------- Posting Idea ----------------
if (postBtn) {
  postBtn.addEventListener("click", async ()=>{
    if(!auth.currentUser) return alert("Please sign in first!");
    const title = ideaTitle.value.trim(), desc = ideaDesc.value.trim();
    if(!title || !desc) return alert("Fill out both fields!");
    try{
      await addDoc(collection(db,"ideas"),{
        title, description: desc,
        author: auth.currentUser.displayName,
        avatar: auth.currentUser.photoURL,
        uid: auth.currentUser.uid,
        reactions:{}, comments:[], created:new Date()
      });
      ideaTitle.value=""; ideaDesc.value="";
    }catch(err){ alert("Error posting idea: "+err.message); }
  });
}

// ---------------- Render Ideas ----------------
const ideasQuery = query(collection(db,"ideas"), orderBy("created","desc"));
let allIdeas = [];
let currentReactionMenu = null;

onSnapshot(ideasQuery, snapshot=>{
  allIdeas = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
  renderAllIdeas();
}, err => {
  console.error("Error listening to ideas:", err);
});

const sortSelect = document.getElementById("sortSelect");
if (sortSelect) {
  sortSelect.addEventListener("change", renderAllIdeas);
}

function renderAllIdeas(){
  let sortedIdeas = [...allIdeas];
  switch(sortSelect?.value){
    case "mostReactions":
      sortedIdeas.sort((a,b)=>getTotalReactions(b.reactions)-getTotalReactions(a.reactions)); break;
    case "mostComments":
      sortedIdeas.sort((a,b)=>(b.comments?.length||0)-(a.comments?.length||0)); break;
    case "newest":
    default:
      // Sort by post creation date, NOT comment dates
      sortedIdeas.sort((a,b)=> {
        // Use the idea's created timestamp, ignore any comment timestamps
        const aDate = a.created?.toDate ? a.created.toDate() : (a.created ? new Date(a.created) : new Date(0));
        const bDate = b.created?.toDate ? b.created.toDate() : (b.created ? new Date(b.created) : new Date(0));
        return bDate.getTime() - aDate.getTime(); // Newest first
      });
      break;
  }
  if (ideasList) {
    ideasList.innerHTML="";
    sortedIdeas.forEach(renderIdea);
  }
}

// ---------------- Render Single Idea ----------------
function renderIdea(idea){
  const card = document.createElement("article"); 
  card.className="card";

  const h3 = document.createElement("h3"); 
  h3.textContent=idea.title || ""; 
  card.appendChild(h3);

  const time = document.createElement("div"); 
  time.className="posted-time"; 
  time.textContent=formatDate(idea.created); 
  card.appendChild(time);

  const authorDiv = document.createElement("div"); 
  authorDiv.className="author";
  
  const avatar = document.createElement("img"); 
  avatar.src = idea.avatar||"https://www.gravatar.com/avatar?d=mp&f=y"; 
  avatar.alt=(idea.author||"Anonymous")+" avatar";
  avatar.style.cursor = "pointer";
  // CRITICAL FIX - Make avatar clickable
  avatar.addEventListener("click", (e) => {
    e.stopPropagation();
    console.log("Avatar clicked for UID:", idea.uid);
    if (idea.uid) {
      loadProfile(idea.uid);
    } else {
      alert("No user ID available");
    }
  });
  authorDiv.appendChild(avatar);
  
  const authorName = document.createElement("span");
  authorName.textContent = idea.author||"Anonymous";
  authorName.style.cursor = "pointer";
  // CRITICAL FIX - Make username clickable
  authorName.addEventListener("click", (e) => {
    e.stopPropagation();
    console.log("Username clicked for UID:", idea.uid);
    if (idea.uid) {
      loadProfile(idea.uid);
    } else {
      alert("No user ID available");
    }
  });
  authorDiv.appendChild(authorName);

  if(idea.uid===ADMIN_UID){
    const devBadge=document.createElement("span"); 
    devBadge.className="devBadge"; 
    devBadge.textContent="Developer"; 
    authorDiv.appendChild(devBadge);
  }
  card.appendChild(authorDiv);

  const descDiv = document.createElement("div"); 
  descDiv.className="markdown-body"; 
  descDiv.innerHTML = markdownToHTML(idea.description || ""); 
  card.appendChild(descDiv);

  // Reactions
  const reactBtn = document.createElement("button"); 
  reactBtn.className="reactBtn"; 
  reactBtn.textContent="â™¥ "+getTotalReactions(idea.reactions); 
  card.appendChild(reactBtn);
  
  const reactionMenu = document.createElement("div"); 
  reactionMenu.className="reactionMenu";
  ["â¤ï¸","ðŸ˜‚","ðŸ‘","ðŸŽ‰","ðŸ˜®","ðŸ˜¢","ðŸ‘Ž"].forEach(emoji=>{
    const btn=document.createElement("button"); 
    btn.textContent=emoji; 
    btn.title=`React with ${emoji}`;
    btn.addEventListener("click", e=>{
      e.stopPropagation();
      if(!auth.currentUser)return alert("Sign in to react!");
      const ref=doc(db,"ideas",idea.id); 
      const userUid=auth.currentUser.uid;
      const arr = idea.reactions?.[emoji]||[]; 
      const hasReacted=arr.includes(userUid);
      if(hasReacted) {
        updateDoc(ref,{ [`reactions.${emoji}`]: arrayRemove(userUid) });
      } else {
        updateDoc(ref,{ [`reactions.${emoji}`]: arrayUnion(userUid) });
      }
    }); 
    reactionMenu.appendChild(btn);
  });
  card.appendChild(reactionMenu);
  
  reactBtn.addEventListener("click", e=>{
    e.stopPropagation();
    if(currentReactionMenu && currentReactionMenu!==reactionMenu) {
      currentReactionMenu.style.display="none";
    }
    reactionMenu.style.display = reactionMenu.style.display==="flex"?"none":"flex";
    currentReactionMenu = reactionMenu.style.display==="flex"?reactionMenu:null;
  });

  const reactionsDisplay=document.createElement("div"); 
  reactionsDisplay.className="reactionsDisplay";
  reactionsDisplay.textContent = Object.entries(idea.reactions||{})
    .filter(([e,a])=>Array.isArray(a) && a.length>0)
    .map(([e,a])=>`${e} ${a.length}`)
    .join("  ");
  card.appendChild(reactionsDisplay);

     // Comments container
   const commentsContainer = document.createElement("div");
   commentsContainer.style.marginTop = "1rem";
   commentsContainer.style.borderTop = "1px solid #e5e7eb";
   commentsContainer.style.paddingTop = "0.7rem";
   
   const commentsDiv = document.createElement("div");
   commentsDiv.className = "comments";
   commentsDiv.style.maxHeight = "180px";
   commentsDiv.style.overflowY = "auto";
   commentsDiv.style.marginBottom = "0.5rem";

   (idea.comments || []).forEach(c => {
    const cmnt = document.createElement("div");
    cmnt.className = "comment";

    const img = document.createElement("img");
    img.src = c.avatar || "https://www.gravatar.com/avatar?d=mp&f=y";
    img.alt = (c.author || "Anonymous") + " avatar";
    img.style.cursor = "pointer";
    img.addEventListener("click", (e) => {
      e.stopPropagation();
      if (c.uid) {
        loadProfile(c.uid);
      }
    });
    cmnt.appendChild(img);

    const textContainer = document.createElement("div");
    textContainer.style.display = "flex";
    textContainer.style.flexDirection = "column";

    const nameTime = document.createElement("span");
    nameTime.className = "comment-author";
    nameTime.style.fontWeight = "600";
    nameTime.style.fontSize = "0.85rem";
    nameTime.style.color = "#4b5563";
    nameTime.style.cursor = "pointer";
    const time = c.created ? new Date(c.created).toLocaleString() : "";
    nameTime.textContent = `${c.author || "Anonymous"} ${time ? "â€¢ " + time : ""}`;
    nameTime.addEventListener("click", (e) => {
      e.stopPropagation();
      if (c.uid) {
        loadProfile(c.uid);
      }
    });
    textContainer.appendChild(nameTime);

    const commentText = document.createElement("span");
    commentText.className = "comment-text";
    commentText.innerHTML = markdownToHTML(c.text || "");
    textContainer.appendChild(commentText);

    cmnt.appendChild(textContainer);

    if (c.uid === ADMIN_UID) {
      const devBadge = document.createElement("span");
      devBadge.className = "devBadge";
      devBadge.textContent = "Developer";
      cmnt.appendChild(devBadge);
    }

         commentsDiv.appendChild(cmnt);
   });
   
   commentsContainer.appendChild(commentsDiv);

   if (auth.currentUser) {
     const commentInput = document.createElement("input");
     commentInput.placeholder = "Add a comment...";
     commentInput.style.width = "100%";
     commentInput.style.padding = "0.6rem 0.9rem";
     commentInput.style.marginTop = "0.5rem";
     commentInput.style.borderRadius = "8px";
     commentInput.style.border = "2px solid #d1d5db";
     commentInput.style.fontSize = "1rem";
     commentInput.style.fontWeight = "500";
     commentInput.style.transition = "border-color .3s ease";
     commentInput.addEventListener("focus", () => {
       commentInput.style.borderColor = "var(--primary)";
       commentInput.style.outline = "none";
       commentInput.style.boxShadow = "0 0 6px var(--primary-light)";
     });
     commentInput.addEventListener("blur", () => {
       commentInput.style.borderColor = "#d1d5db";
       commentInput.style.boxShadow = "none";
     });
     commentInput.addEventListener("keypress", async e => {
       if (e.key === "Enter" && commentInput.value.trim()) {
         try {
           const ref = doc(db, "ideas", idea.id);
           await updateDoc(ref, {
             comments: arrayUnion({
               text: commentInput.value.trim(),
               author: auth.currentUser.displayName,
               avatar: auth.currentUser.photoURL,
               uid: auth.currentUser.uid,
               created: new Date().toISOString()
             })
           });
           commentInput.value = "";
         } catch (err) {
           alert("Error adding comment: " + err.message);
         }
       }
     });
     commentsContainer.appendChild(commentInput);
   }

   card.appendChild(commentsContainer);

  if(isAdmin){
    const delBtn=document.createElement("button"); 
    delBtn.className="danger"; 
    delBtn.textContent="Delete Post";
    delBtn.addEventListener("click", async ()=>{ 
      if(confirm("Delete this post?")) {
        try {
          await deleteDoc(doc(db,"ideas",idea.id));
        } catch (err) {
          alert("Error deleting post: " + err.message);
        }
      }
    }); 
    card.appendChild(delBtn);
  }

  if (ideasList) {
    ideasList.appendChild(card);
  }
}

function markdownToHTML(md){ 
  if (!md) return "";
  return md
    .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
    .replace(/\*(.*?)\*/g,'<i>$1</i>')
    .replace(/\n/g, '<br>');
}

function formatDate(d){ 
  if (!d) return "";
  try {
    d = d?.toDate ? d.toDate() : new Date(d); 
    return d.toLocaleString(); 
  } catch (e) {
    return "Unknown date";
  }
}

function getTotalReactions(reactions){ 
  if (!reactions) return 0;
  return Object.values(reactions).reduce((a,v)=>a+(Array.isArray(v)?v.length:0),0); 
}

// Close reaction menu when clicking outside
document.addEventListener("click", (e) => {
  if(currentReactionMenu && !currentReactionMenu.contains(e.target)){ 
    const reactBtns = document.querySelectorAll(".reactBtn");
    let clickedReactBtn = false;
    reactBtns.forEach(btn => {
      if (btn.contains(e.target)) clickedReactBtn = true;
    });
    if (!clickedReactBtn) {
      currentReactionMenu.style.display="none"; 
      currentReactionMenu=null; 
    }
  } 
});
</script>
</body>
</html>

