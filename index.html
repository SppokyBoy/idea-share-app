<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Idea Share App</title>
<style>
:root {
  --primary: #4f46e5;
  --primary-light: hsl(239, 84%, 67%);
  --primary-dark: #4338ca;
  --background: #f9fafb;
  --card-bg: #ffffff;
  --text-primary: #1f2937;
  --text-secondary: #4b5563;
  --accent: #4338ca;
  --shadow-color: rgba(79, 70, 229, 0.3);
  --button-bg: var(--accent);
  --button-bg-hover: #4338ca;
  --button-shadow: #2a228a;
}

* { box-sizing: border-box; transition: background-color .3s ease, color .3s ease; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 650px; margin: 2rem auto; padding: 1rem 1.5rem; background: var(--background); color: var(--text-primary); }
h1 { text-align:center; margin-bottom:1rem; color:var(--button-bg); font-weight:700; font-size:2.4rem; letter-spacing:.05em; user-select:none; cursor:default; text-shadow:0 2px 6px var(--button-shadow); }

#adminPanel { display:none; margin:1rem 0 1.5rem 0; padding:.9rem 1rem; border-radius:12px; background:#eef2ff; border:2px dashed var(--primary-dark); box-shadow:0 6px 16px rgba(0,0,0,.06); }
#adminPanel h3 { margin:0 0 .5rem 0; }
.adminRow { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
.adminBadge { font-size:.9rem; color:var(--text-secondary); }

button { background: var(--button-bg); border:none; color:white; padding:0.6rem 1.0rem; font-size:1rem; font-weight:600; border-radius:8px; cursor:pointer; box-shadow:0 6px 12px var(--button-shadow); user-select:none; outline-offset:4px; outline-color:transparent; outline-style:solid; transition:background .3s ease, box-shadow .3s ease, transform .15s ease, outline-color .3s ease; display:inline-block; margin:0.25rem 0; }
button:hover { background: var(--button-bg-hover); box-shadow:0 8px 20px var(--button-shadow); transform:translateY(-2px); outline-color: var(--accent); }
button:active { transform:translateY(1px); box-shadow:0 4px 10px var(--button-shadow); }
.danger { background: #dc2626; }
.danger:hover { background:#b91c1c; }

input, textarea { width:100%; padding:.6rem .9rem; margin:.5rem 0 1rem 0; border-radius:8px; border:2px solid #d1d5db; font-size:1rem; font-weight:500; color: var(--text-primary); background:white; transition:border-color .3s ease; resize: vertical; font-family:inherit; }
input:focus, textarea:focus { border-color: var(--primary); outline:none; box-shadow:0 0 6px var(--primary-light); }

#ideaForm { margin-bottom:2rem; background:var(--card-bg); padding:1.4rem 1.6rem; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.08); animation:fadeIn .8s ease forwards; }
#ideasList { display:flex; flex-direction:column; gap:1.2rem; }
.card { position:relative; background:var(--card-bg); padding:1.2rem 1.6rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); opacity:0; transform:translateY(15px); animation:fadeInUp .5s ease forwards; transition: box-shadow .3s ease; }
.card:hover { box-shadow:0 8px 24px rgba(0,0,0,0.12); }
.card h3 { margin:0 0 .3rem 0; font-weight:700; color:var(--primary-dark); }

.posted-time { font-size:.85rem; color:var(--text-secondary); margin-bottom:.5rem; }
.author { margin-bottom:.7rem; display:flex; align-items:center; gap:.5rem; color:var(--text-secondary); font-weight:600; }
.author img { width:28px; height:28px; border-radius:50%; box-shadow:0 0 4px var(--primary-light); }
.devBadge { background:#facc15; color:#1f2937; font-size:.75rem; font-weight:700; padding:0 6px; border-radius:6px; margin-left:4px; }
.markdown-body { color: var(--text-primary); line-height:1.5; margin-bottom:1rem; font-weight:500; font-size:1rem; user-select:text; white-space:pre-wrap; }

.reactBtn { margin-bottom:.5rem; font-weight:700; font-size:1.05rem; padding:.45rem .95rem; border-radius:24px; color:white; user-select:none; display:inline-flex; align-items:center; gap:6px; background:var(--button-bg); box-shadow:0 6px 12px var(--button-shadow); border:none; }
.reactionMenu { position:absolute; bottom:100%; left:0; display:none; gap:8px; padding:.3rem .6rem; border-radius:30px; background:var(--card-bg); box-shadow:0 4px 16px rgba(0,0,0,.15); user-select:none; z-index:1000; white-space:nowrap; }
.reactionMenu button { background:transparent; border:none; font-size:1.5rem; cursor:pointer; padding:0 6px; transition: transform .15s ease; color:var(--text-primary); }
.reactionMenu button:hover { transform:scale(1.3); }

.reactionsDisplay { margin-top:6px; font-size:1.2rem; user-select:none; color:var(--accent); min-height:1.4rem; }
.comments { margin-top:1rem; border-top:1px solid #e5e7eb; padding-top:.7rem; max-height:180px; overflow-y:auto; font-size:.95rem; color:var(--text-secondary); user-select:text; }
.comment { margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem; line-height:1.3; }
.comment img { width:22px; height:22px; border-radius:50%; box-shadow:0 0 3px var(--primary-light); }
.comment .comment-text { display:inline-block; word-break:break-word; }

#authButtons { display:flex; justify-content:center; gap:1rem; margin-bottom:1rem; }
#customization { display:flex; justify-content:center; gap:1.5rem; margin-bottom:1.2rem; flex-wrap:wrap; font-weight:600; color:var(--text-secondary); }
#customization input[type="color"] { margin-top:.3rem; width:40px; height:30px; border:none; cursor:pointer; border-radius:6px; box-shadow:0 0 5px rgba(0,0,0,.1); }

@keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
@keyframes fadeInUp { from {opacity:0; transform: translateY(15px);} to {opacity:1; transform: translateY(0);} }
</style>
</head>
<body>

<h1>The Idea App</h1>

<section id="adminPanel">
  <h3>🔒 Admin Panel</h3>
  <div class="adminRow">
    <span class="adminBadge" id="adminUidBadge">UID: —</span>
    <button id="deleteAllBtn" class="danger">Delete ALL Ideas</button>
  </div>
  <small style="color:#6b7280;">Only visible to your admin account. Actions are immediate.</small>
</section>

<div id="authButtons">
  <button id="signInBtn">Sign In with Google</button>
  <button id="signOutBtn" style="display:none;">Sign Out</button>
</div>

<div id="customization">
  <label>Background Color: <input type="color" id="bgColorPicker" value="#f9fafb"></label>
  <label>Button Color: <input type="color" id="btnColorPicker" value="#ec4899"></label>
</div>

<div id="ideaForm" style="display:none;">
  <input id="ideaTitle" placeholder="Idea Title" />
  <textarea id="ideaDesc" rows="4" placeholder="Describe your idea in markdown..."></textarea>
  <button id="postIdea">Post Idea</button>
</div>

<div id="sortOptions" style="margin-bottom:1rem; text-align:center;">
  <label for="sortSelect">Sort by: </label>
  <select id="sortSelect">
    <option value="newest">Newest</option>
    <option value="mostReactions">Most Reactions</option>
    <option value="mostComments">Most Comments</option>
  </select>
</div>

<div id="ideasList"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, arrayUnion, arrayRemove, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAu2x0HdXxGiLv1Rhjqwv4Lkp2Wooo13L0",
  authDomain: "theideaapp-2ff99.firebaseapp.com",
  projectId: "theideaapp-2ff99",
  storageBucket: "theideaapp-2ff99.firebasestorage.app",
  messagingSenderId: "964418361365",
  appId: "1:964418361365:web:44fd66314e75b4181e561c",
  measurementId: "G-FJQ0228EZK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt: 'select_account' });

const ADMIN_UID = "x7GUnYJAeGg4qx68iZfT0Ns46EC3";
let isAdmin = false;

const adminPanel = document.getElementById("adminPanel");
const adminUidBadge = document.getElementById("adminUidBadge");
const deleteAllBtn = document.getElementById("deleteAllBtn");
const ideasList = document.getElementById("ideasList");
const postBtn = document.getElementById("postIdea");
const ideaTitle = document.getElementById("ideaTitle");
const ideaDesc = document.getElementById("ideaDesc");
const signInBtn = document.getElementById("signInBtn");
const signOutBtn = document.getElementById("signOutBtn");
const ideaForm = document.getElementById("ideaForm");
const bgColorPicker = document.getElementById("bgColorPicker");
const btnColorPicker = document.getElementById("btnColorPicker");

// ---------------- Customization ----------------
bgColorPicker.addEventListener("input", e => { document.body.style.backgroundColor = e.target.value; });
btnColorPicker.addEventListener("input", e => {
  const val = e.target.value;
  document.documentElement.style.setProperty("--accent", val);
  document.documentElement.style.setProperty("--button-bg", val);
  document.documentElement.style.setProperty("--button-bg-hover", shadeColor(val, -20));
  document.documentElement.style.setProperty("--button-shadow", hexToRgba(val, 0.4));
});
function shadeColor(color, percent) {
  let R = parseInt(color.substring(1,3),16), G = parseInt(color.substring(3,5),16), B = parseInt(color.substring(5,7),16);
  R = Math.min(255, Math.max(0, parseInt(R*(100+percent)/100)));
  G = Math.min(255, Math.max(0, parseInt(G*(100+percent)/100)));
  B = Math.min(255, Math.max(0, parseInt(B*(100+percent)/100)));
  return "#" + [R,G,B].map(v=>v.toString(16).padStart(2,"0")).join("");
}
function hexToRgba(hex,a){ const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }

// ---------------- Auth ----------------
signInBtn.onclick = async ()=>{ try{ await signInWithPopup(auth, provider); } catch(e){ alert("Sign-in failed: "+e.message); } };
signOutBtn.onclick = async ()=>{ try{ await signOut(auth); } catch(e){ alert("Sign-out failed: "+e.message); } };

onAuthStateChanged(auth,user=>{
  if(user){
    signInBtn.style.display="none"; signOutBtn.style.display="inline-block"; ideaForm.style.display="block";
    isAdmin = (user.uid === ADMIN_UID);
    adminPanel.style.display = isAdmin ? "block":"none";
    adminUidBadge.textContent = "UID: "+user.uid;
    renderAllIdeas();
  } else {
    signInBtn.style.display="inline-block"; signOutBtn.style.display="none"; ideaForm.style.display="none";
    isAdmin=false; adminPanel.style.display="none";
    renderAllIdeas();
  }
});

// ---------------- Admin Actions ----------------
deleteAllBtn.onclick = async ()=>{
  if(!isAdmin) return;
  if(!confirm("⚠️ Delete ALL ideas?")) return;
  try{
    const qsnap = await getDocs(collection(db,"ideas"));
    const ops = []; qsnap.forEach(d=>ops.push(deleteDoc(doc(db,"ideas",d.id))));
    await Promise.all(ops);
    alert("All ideas deleted.");
  }catch(err){ alert("Error deleting all ideas: "+err.message); }
};

// ---------------- Posting Idea ----------------
postBtn && (postBtn.onclick = async ()=>{
  if(!auth.currentUser) return alert("Please sign in first!");
  const title = ideaTitle.value.trim(), desc = ideaDesc.value.trim();
  if(!title || !desc) return alert("Fill out both fields!");
  try{
    await addDoc(collection(db,"ideas"),{
      title, description: desc,
      author: auth.currentUser.displayName,
      avatar: auth.currentUser.photoURL,
      uid: auth.currentUser.uid,
      reactions:{}, comments:[], created:new Date()
    });
    ideaTitle.value=""; ideaDesc.value="";
  }catch(err){ alert("Error posting idea: "+err.message); }
});

// ---------------- Render Ideas ----------------
const ideasQuery = query(collection(db,"ideas"), orderBy("created","desc"));
let allIdeas = [];
let currentReactionMenu = null;

onSnapshot(ideasQuery, snapshot=>{
  allIdeas = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
  renderAllIdeas();
});

const sortSelect = document.getElementById("sortSelect");
sortSelect.addEventListener("change", renderAllIdeas);

function renderAllIdeas(){
  let sortedIdeas = [...allIdeas];
  switch(sortSelect.value){
    case "mostReactions":
      sortedIdeas.sort((a,b)=>getTotalReactions(b.reactions)-getTotalReactions(a.reactions)); break;
    case "mostComments":
      sortedIdeas.sort((a,b)=>(b.comments?.length||0)-(a.comments?.length||0)); break;
    default:
      sortedIdeas.sort((a,b)=> b.created.toDate ? b.created.toDate() - a.created.toDate() : new Date(b.created) - new Date(a.created));
  }
  ideasList.innerHTML="";
  sortedIdeas.forEach(renderIdea);
}

// ---------------- Render Single Idea ----------------
function renderIdea(idea){
  const card = document.createElement("article"); card.className="card";

  const h3 = document.createElement("h3"); h3.textContent=idea.title; card.appendChild(h3);

  const time = document.createElement("div"); time.className="posted-time"; time.textContent=formatDate(idea.created); card.appendChild(time);

  const authorDiv = document.createElement("div"); authorDiv.className="author";
  const avatar = document.createElement("img"); avatar.src = idea.avatar||"https://www.gravatar.com/avatar?d=mp&f=y"; avatar.alt=(idea.author||"Anonymous")+" avatar"; authorDiv.appendChild(avatar);
  const authorName = document.createElement("span"); authorName.textContent = idea.author||"Anonymous"; authorDiv.appendChild(authorName);

  // Developer badge on post
  if(idea.uid===ADMIN_UID){
    const devBadge=document.createElement("span"); devBadge.className="devBadge"; devBadge.textContent="Developer"; authorDiv.appendChild(devBadge);
  }
  card.appendChild(authorDiv);

  const descDiv = document.createElement("div"); descDiv.className="markdown-body"; descDiv.innerHTML = markdownToHTML(idea.description); card.appendChild(descDiv);

  // Reactions
  const reactBtn = document.createElement("button"); reactBtn.className="reactBtn"; reactBtn.textContent="♥ "+getTotalReactions(idea.reactions); card.appendChild(reactBtn);
  const reactionMenu = document.createElement("div"); reactionMenu.className="reactionMenu";
  ["❤️","😂","👍","🎉","😮","😢","👎"].forEach(emoji=>{
    const btn=document.createElement("button"); btn.textContent=emoji; btn.title=`React with ${emoji}`;
    btn.onclick=e=>{
      e.stopPropagation();
      if(!auth.currentUser)return alert("Sign in to react!");
      const ref=doc(db,"ideas",idea.id); const userUid=auth.currentUser.uid;
      const arr = idea.reactions?.[emoji]||[]; const hasReacted=arr.includes(userUid);
      if(hasReacted) updateDoc(ref,{ [`reactions.${emoji}`]: arrayRemove(userUid) });
      else updateDoc(ref,{ [`reactions.${emoji}`]: arrayUnion(userUid) });
    }; reactionMenu.appendChild(btn);
  });
  card.appendChild(reactionMenu);
  reactBtn.onclick=e=>{
    e.stopPropagation();
    if(currentReactionMenu && currentReactionMenu!==reactionMenu) currentReactionMenu.style.display="none";
    reactionMenu.style.display = reactionMenu.style.display==="flex"?"none":"flex";
    currentReactionMenu = reactionMenu.style.display==="flex"?reactionMenu:null;
  };
  document.body.addEventListener("click", ()=>{ if(currentReactionMenu){ currentReactionMenu.style.display="none"; currentReactionMenu=null; } });

  const reactionsDisplay=document.createElement("div"); reactionsDisplay.className="reactionsDisplay";
  reactionsDisplay.textContent = Object.entries(idea.reactions||{}).filter(([e,a])=>a.length>0).map(([e,a])=>`${e} ${a.length}`).join("  ");
  card.appendChild(reactionsDisplay);

  // Comments
const commentsDiv = document.createElement("div");
commentsDiv.className = "comments";

(idea.comments || []).forEach(c => {
    const cmnt = document.createElement("div");
    cmnt.className = "comment";

    const img = document.createElement("img");
    img.src = c.avatar || "https://www.gravatar.com/avatar?d=mp&f=y";
    img.alt = (c.author || "Anonymous") + " avatar";
    cmnt.appendChild(img);

    const textContainer = document.createElement("div");
    textContainer.style.display = "flex";
    textContainer.style.flexDirection = "column";

    const nameTime = document.createElement("span");
    nameTime.style.fontWeight = "600";
    nameTime.style.fontSize = "0.85rem";
    nameTime.style.color = "#4b5563";
    const time = c.created ? new Date(c.created).toLocaleString() : "";
    nameTime.textContent = `${c.author || "Anonymous"} ${time ? "• " + time : ""}`;
    textContainer.appendChild(nameTime);

    const commentText = document.createElement("span");
    commentText.className = "comment-text";
    commentText.innerHTML = markdownToHTML(c.text || "");
    textContainer.appendChild(commentText);

    cmnt.appendChild(textContainer);

    // Developer badge on comment
    if (c.uid === ADMIN_UID) {
        const devBadge = document.createElement("span");
        devBadge.className = "devBadge";
        devBadge.textContent = "Developer";
        cmnt.appendChild(devBadge);
    }

    commentsDiv.appendChild(cmnt);
});

// Comment input
if (auth.currentUser) {
    const commentInput = document.createElement("input");
    commentInput.placeholder = "Add a comment...";
    commentInput.addEventListener("keypress", async e => {
        if (e.key === "Enter" && commentInput.value.trim()) {
            const ref = doc(db, "ideas", idea.id);
            await updateDoc(ref, {
                comments: arrayUnion({
                    text: commentInput.value.trim(),
                    author: auth.currentUser.displayName,
                    avatar: auth.currentUser.photoURL,
                    uid: auth.currentUser.uid,
                    created: new Date().toISOString()
                })
            });
            commentInput.value = "";
        }
    });
    commentsDiv.appendChild(commentInput);
}

card.appendChild(commentsDiv);


  // Admin delete post
  if(isAdmin){
    const delBtn=document.createElement("button"); delBtn.className="danger"; delBtn.textContent="Delete Post";
    delBtn.onclick=async()=>{ if(confirm("Delete this post?")) await deleteDoc(doc(db,"ideas",idea.id)); };
    card.appendChild(delBtn);
  }

  ideasList.appendChild(card);
}

function markdownToHTML(md){ return md.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\*(.*?)\*/g,'<i>$1</i>'); }
function formatDate(d){ d = d.toDate ? d.toDate() : new Date(d); return d.toLocaleString(); }
function getTotalReactions(reactions){ return Object.values(reactions||{}).reduce((a,v)=>a+v.length,0); }
</script>
</body>
</html>
