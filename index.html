<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Idea Share App</title>
<style>
:root {
  --primary: #4f46e5;
  --primary-light: hsl(239, 84%, 67%);
  --primary-dark: #4338ca;
  --background: #f9fafb;
  --card-bg: #ffffff;
  --text-primary: #1f2937;
  --text-secondary: #4b5563;
  --accent: #4338ca;
  --shadow-color: rgba(79, 70, 229, 0.3);
  --button-bg: var(--accent);
  --button-bg-hover: #4338ca;
  --button-shadow: #2a228a;
}

* { box-sizing: border-box; transition: background-color .3s ease, color .3s ease; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 650px; margin: 2rem auto; padding: 1rem 1.5rem; background: var(--background); color: var(--text-primary); }
#topBar { position:fixed; top:12px; right:16px; display:none; align-items:center; gap:.6rem; z-index:1500; background:linear-gradient(135deg, var(--card-bg) 0%, rgba(255,255,255,0.95) 100%); padding:.5rem .75rem; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.12); border:1px solid rgba(79,70,229,.15); }
#topBar label { font-weight:600; color:var(--text-secondary); font-size:.9rem; }
h1 { text-align:center; margin-bottom:1rem; color:var(--button-bg); font-weight:700; font-size:2.4rem; letter-spacing:.05em; user-select:none; cursor:default; text-shadow:0 2px 6px var(--button-shadow); }
.welcome-screen { 
  text-align:center; 
  padding:4rem 2rem; 
  max-width:700px; 
  margin:3rem auto;
  background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(255, 255, 255, 0.95) 100%);
  border-radius:20px;
  box-shadow: 0 10px 40px rgba(79, 70, 229, 0.15);
  border: 2px solid rgba(79, 70, 229, 0.1);
  animation: fadeInUp 0.8s ease;
}
.welcome-screen h2 { 
  font-size:3rem; 
  font-weight:700; 
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom:1.5rem;
  letter-spacing: -0.02em;
}
.welcome-screen p { 
  font-size:1.4rem; 
  color:var(--text-secondary); 
  line-height:1.8; 
  margin-bottom:2.5rem;
  font-weight:500;
}
.welcome-screen .welcome-icon {
  font-size: 5rem;
  margin-bottom: 1rem;
  display: block;
  animation: float 3s ease-in-out infinite;
}
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

#adminPanel { display:none; margin:1rem 0 1.5rem 0; padding:.9rem 1rem; border-radius:12px; background:#eef2ff; border:2px dashed var(--primary-dark); box-shadow:0 6px 16px rgba(0,0,0,.06); }
#adminPanel h3 { margin:0 0 .5rem 0; }
.adminRow { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
.adminBadge { font-size:.9rem; color:var(--text-secondary); }

button { background: var(--button-bg); border:none; color:white; padding:0.6rem 1.0rem; font-size:1rem; font-weight:600; border-radius:8px; cursor:pointer; box-shadow:0 6px 12px var(--button-shadow); user-select:none; outline-offset:4px; outline-color:transparent; outline-style:solid; transition:background .3s ease, box-shadow .3s ease, transform .15s ease, outline-color .3s ease; display:inline-block; margin:0.25rem 0; }
button:hover { background: var(--button-bg-hover); box-shadow:0 8px 20px var(--button-shadow); transform:translateY(-2px); outline-color: var(--accent); }
button:active { transform:translateY(1px); box-shadow:0 4px 10px var(--button-shadow); }
.danger { background: #dc2626; }
.danger:hover { background:#b91c1c; }
.secondary { background: #6b7280; }
.secondary:hover { background: #4b5563; }

input, textarea { width:100%; padding:.6rem .9rem; margin:.5rem 0 1rem 0; border-radius:8px; border:2px solid #d1d5db; font-size:1rem; font-weight:500; color: var(--text-primary); background:white; transition:border-color .3s ease; resize: vertical; font-family:inherit; }
input:focus, textarea:focus { border-color: var(--primary); outline:none; box-shadow:0 0 6px var(--primary-light); }

#ideaForm { margin-bottom:2rem; background:var(--card-bg); padding:1.4rem 1.6rem; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.08); animation:fadeIn .8s ease forwards; }
#ideasList { display:flex; flex-direction:column; gap:1.2rem; }
.card { position:relative; background:var(--card-bg); padding:1.2rem 1.6rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); opacity:0; transform:translateY(15px); animation:fadeInUp .5s ease forwards; transition: box-shadow .3s ease; }
.card:hover { box-shadow:0 8px 24px rgba(0,0,0,0.12); }
.card h3 { margin:0 0 .3rem 0; font-weight:700; color:var(--primary-dark); }

.posted-time { font-size:.85rem; color:var(--text-secondary); margin-bottom:.5rem; }
.author { margin-bottom:.7rem; display:flex; align-items:center; gap:.5rem; color:var(--text-secondary); font-weight:600; }
.author img { width:28px; height:28px; border-radius:50%; box-shadow:0 0 4px var(--primary-light); cursor:pointer; transition: transform .2s ease; }
.author img:hover { transform: scale(1.1); }
.author span { cursor:pointer; transition: color .2s ease; }
.author span:hover { color: var(--primary); }
.devBadge { background:#facc15; color:#1f2937; font-size:.75rem; font-weight:700; padding:0 6px; border-radius:6px; margin-left:4px; }
.markdown-body { color: var(--text-primary); line-height:1.5; margin-bottom:1rem; font-weight:500; font-size:1rem; user-select:text; white-space:pre-wrap; }

.reactBtn { margin-bottom:.5rem; font-weight:700; font-size:1.05rem; padding:.45rem .95rem; border-radius:24px; color:white; user-select:none; display:inline-flex; align-items:center; gap:6px; background:var(--button-bg); box-shadow:0 6px 12px var(--button-shadow); border:none; }
.reactionMenu { position:absolute; bottom:100%; left:0; display:none; gap:8px; padding:.3rem .6rem; border-radius:30px; background:var(--card-bg); box-shadow:0 4px 16px rgba(0,0,0,.15); user-select:none; z-index:1000; white-space:nowrap; flex-wrap:wrap; }
.reactionMenu button { background:transparent; border:none; font-size:1.5rem; cursor:pointer; padding:0 6px; transition: transform .15s ease; color:var(--text-primary); }
.reactionMenu button:hover { transform:scale(1.3); }

 .reactionsDisplay { margin-top:6px; font-size:1.2rem; user-select:none; color:var(--accent); min-height:1.4rem; }
 .comments { font-size:.95rem; color:var(--text-secondary); user-select:text; }
.comment { margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem; line-height:1.3; }
.comment img { width:22px; height:22px; border-radius:50%; box-shadow:0 0 3px var(--primary-light); cursor:pointer; }
.comment .comment-text { display:inline-block; word-break:break-word; }
.comment-author { cursor:pointer; font-weight:600; transition: color .2s ease; }
.comment-author:hover { color: var(--primary); }

#authButtons { display:flex; justify-content:center; gap:1rem; margin-bottom:1rem; }
#authButtons button { font-size:1.2rem; padding:0.8rem 1.5rem; }
#customization { display:flex; justify-content:center; gap:1.5rem; margin-bottom:1.2rem; flex-wrap:wrap; font-weight:600; color:var(--text-secondary); }
#customization input[type="color"] { margin-top:.3rem; width:40px; height:30px; border:none; cursor:pointer; border-radius:6px; box-shadow:0 0 5px rgba(0,0,0,.1); }

/* Profile Modal Styles - CRITICAL FIX */
#profileModal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center; padding:1rem; }
#profileModal.active { display:flex !important; }
#profileContent { background:var(--card-bg); border-radius:16px; padding:2rem; max-width:500px; width:100%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); position:relative; animation:fadeInUp .3s ease; }
#closeProfile { position:absolute; top:1rem; right:1rem; background:transparent; border:none; font-size:2rem; color:var(--text-secondary); cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:background .2s ease; line-height:1; padding:0; }
#closeProfile:hover { background:#f3f4f6; }
.profile-header { display:flex; gap:1.5rem; margin-bottom:1.5rem; align-items:flex-start; }
.profile-avatar-large { width:80px; height:80px; border-radius:50%; box-shadow:0 4px 12px rgba(0,0,0,0.15); object-fit:cover; flex-shrink:0; }
.avatar-frame { box-shadow: 0 0 0 3px #fff, 0 0 0 5px var(--primary); }
.avatar-frame-gold { box-shadow: 0 0 0 3px #fff, 0 0 0 5px #f59e0b; }
.avatar-frame-rainbow { position:relative; }
.avatar-frame-rainbow::after { content:""; position:absolute; inset:-4px; border-radius:50%; padding:4px; background:conic-gradient(#f87171,#fbbf24,#34d399,#60a5fa,#a78bfa,#f472b6,#f87171); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }
/* Extra fun frames */
.avatar-frame-neon { box-shadow: 0 0 0 3px #fff, 0 0 12px 4px #22d3ee, 0 0 0 5px #06b6d4; }
.avatar-frame-dotted { outline: 4px dotted #8b5cf6; outline-offset: 2px; }
.avatar-frame-gradient { position:relative; }
.avatar-frame-gradient::after { content:""; position:absolute; inset:-5px; border-radius:50%; padding:5px; background:conic-gradient(#06b6d4,#22c55e,#f59e0b,#ef4444,#06b6d4); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }
.avatar-frame-blue { box-shadow: 0 0 0 3px #fff, 0 0 0 5px #3b82f6; }
.avatar-frame-pink { box-shadow: 0 0 0 3px #fff, 0 0 0 5px #ec4899; }
.avatar-frame-glowpurple { box-shadow: 0 0 0 3px #fff, 0 0 14px 6px #a78bfa, 0 0 0 5px #8b5cf6; }
.profile-info { flex:1; min-width:0; }
.profile-name { font-size:1.5rem; font-weight:700; margin-bottom:.5rem; color:var(--text-primary); display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
.profile-bio { color:var(--text-secondary); line-height:1.6; margin-bottom:1rem; white-space:pre-wrap; word-wrap:break-word; }
.profile-stats { display:flex; gap:1.5rem; margin-bottom:1rem; }
.profile-stat { text-align:center; transition:transform .2s ease; }
#followersStat:hover, #followingStat:hover, #profilePageFollowersStat:hover, #profilePageFollowingStat:hover { transform:scale(1.05); }
.profile-stat-value { font-size:1.2rem; font-weight:700; color:var(--primary-dark); }
 .profile-stat-label { font-size:.85rem; color:var(--text-secondary); }
 .profile-actions { display:flex; gap:.5rem; margin-top:.5rem; flex-wrap:wrap; }
 
 /* Followers/Following Modal */
 .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2001; align-items:center; justify-content:center; padding:1rem; }
 .modal.active { display:flex !important; }
 .modal-content { background:var(--card-bg); border-radius:16px; padding:1.5rem; max-width:400px; width:100%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:fadeInUp .3s ease; }
 .follower-item { display:flex; align-items:center; gap:1rem; padding:.75rem; border-radius:8px; margin-bottom:.5rem; transition:background .2s ease; cursor:pointer; }
 .follower-item:hover { background:#f3f4f6; }
 .follower-item img { width:40px; height:40px; border-radius:50%; object-fit:cover; }
 .follower-item-info { flex:1; }
 .follower-item-name { font-weight:600; color:var(--primary-dark); margin:0; }
 .follower-item-bio { font-size:.85rem; color:var(--text-secondary); margin:.25rem 0 0 0; }
#profileIdeasList { margin-top:1.5rem; }
.profile-idea-card { background:#f9fafb; padding:1rem; border-radius:8px; margin-bottom:.75rem; }
.profile-idea-card h4 { margin:0 0 .5rem 0; color:var(--primary-dark); font-size:1rem; }
.profile-idea-card .idea-time { font-size:.75rem; color:var(--text-secondary); }

 /* Navigation */
 #navBar { 
   display:flex; 
   flex-direction:column;
   gap:.5rem; 
   position:fixed; 
   top:50%; 
   left:1.5rem; 
   transform:translateY(-50%);
   z-index:1000;
   background:linear-gradient(135deg, var(--card-bg) 0%, rgba(255,255,255,0.95) 100%);
   padding:1.25rem 1rem;
   border-radius:16px;
   box-shadow:0 8px 32px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08);
   border:1px solid rgba(79, 70, 229, 0.2);
   backdrop-filter:blur(10px);
 }
 .nav-link { 
   background:rgba(79, 70, 229, 0.05); 
   border:2px solid transparent; 
   color:var(--primary-dark); 
   padding:.85rem 1.5rem; 
   transition:all .3s cubic-bezier(0.4, 0, 0.2, 1); 
   border-radius:10px;
   white-space:nowrap;
   min-width:140px;
   text-align:center;
   font-weight:600;
   font-size:0.95rem;
   cursor:pointer;
   position:relative;
   overflow:hidden;
 }
 .nav-link::before {
   content:'';
   position:absolute;
   left:0;
   top:0;
   width:4px;
   height:100%;
   background:var(--primary);
   transform:scaleY(0);
   transition:transform .3s ease;
 }
 .nav-link:hover { 
   background:rgba(79, 70, 229, 0.1); 
   color:var(--primary-dark);
   transform:translateX(5px);
   border-color:rgba(79, 70, 229, 0.3);
   box-shadow:0 4px 12px rgba(79, 70, 229, 0.15);
 }
 .nav-link:hover::before {
   transform:scaleY(1);
 }
 .nav-link.active { 
   background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
   color:white;
   box-shadow:0 4px 16px var(--button-shadow), inset 0 1px 0 rgba(255,255,255,0.2);
   border-color:var(--primary-dark);
   transform:translateX(3px);
 }
 .nav-link.active::before {
   transform:scaleY(1);
   background:white;
   width:4px;
 }

@keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
@keyframes fadeInUp { from {opacity:0; transform: translateY(15px);} to {opacity:1; transform: translateY(0);} }

@media (max-width: 900px) {
  body { padding: 1rem; margin: 0 auto; padding-bottom: 90px; }
  h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
  
  /* Welcome screen mobile */
  .welcome-screen { 
    padding: 2.5rem 1.5rem; 
    margin: 1.5rem auto;
    border-radius: 16px;
  }
  .welcome-screen h2 { font-size: 2rem; margin-bottom: 1rem; }
  .welcome-screen p { font-size: 1.1rem; margin-bottom: 2rem; }
  .welcome-screen .welcome-icon { font-size: 3.5rem; }
  
  /* Navigation - move to bottom on mobile */
  #navBar { 
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    top: auto;
    transform: none;
    flex-direction: row;
    justify-content: space-around;
    padding: 0.75rem 0.5rem;
    border-radius: 20px 20px 0 0;
    border-left: none;
    border-right: none;
    border-bottom: none;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    backdrop-filter: blur(20px);
  }
  .nav-link { 
    padding: 0.6rem 0.8rem;
    min-width: auto;
    flex: 1;
    font-size: 0.75rem;
    border-radius: 8px;
  }
  .nav-link:hover { transform: none; }
  .nav-link.active { transform: none; }
  .nav-link::before { display: none; }
  
  /* Top bar mobile */
  #topBar { 
    top: 8px;
    right: 8px;
    left: auto;
    padding: 0.5rem;
    flex-direction: column;
    gap: 0.4rem;
    max-width: 140px;
  }
  #topBar label { font-size: 0.75rem; }
  #topBar input[type="color"] { width: 30px; height: 25px; }
  #signOutBtn { font-size: 0.85rem; padding: 0.5rem 0.8rem; }
  
  /* Cards and content */
  .card { padding: 1rem 1.2rem; border-radius: 10px; }
  #ideaForm { padding: 1.2rem 1.2rem; border-radius: 10px; }
  input, textarea { font-size: 16px; padding: 0.7rem 0.9rem; }
  button { padding: 0.7rem 1.2rem; font-size: 0.95rem; }
  
  /* Profile modal mobile */
  #profileContent { 
    padding: 1.5rem 1.2rem;
    max-width: 100%;
    max-height: 95vh;
    border-radius: 20px 20px 0 0;
    margin-top: auto;
  }
  .profile-header { flex-direction: column; align-items: center; text-align: center; gap: 1rem; }
  .profile-avatar-large { width: 70px; height: 70px; }
  .profile-stats { justify-content: center; gap: 1rem; }
  .profile-stat-value { font-size: 1.1rem; }
  .profile-stat-label { font-size: 0.8rem; }
  
  /* Auth buttons */
  #authButtons { flex-direction: column; }
  #authButtons button { width: 100%; font-size: 1.1rem; padding: 0.9rem 1.5rem; }
  
  /* Reaction menu */
  .reactionMenu { 
    bottom: auto;
    top: 100%;
    left: 0;
    right: 0;
    justify-content: center;
    padding: 0.5rem;
  }
  
  /* Comments */
  .comment { font-size: 0.9rem; }
  .comments { font-size: 0.9rem; }
  
  /* Admin panel */
  #adminPanel { padding: 0.8rem; }
  .adminRow { flex-direction: column; align-items: flex-start; }
  
  /* Profile page */
  .profile-idea-card { padding: 0.9rem; }
  
  /* Modal content */
  .modal-content { 
    padding: 1.2rem;
    max-width: 100%;
    border-radius: 20px 20px 0 0;
    margin-top: auto;
  }
  
  /* Sort options */
  #sortOptions { margin-bottom: 0.8rem; }
  #sortOptions select { font-size: 0.95rem; padding: 0.5rem; }
  
  /* Markdown body */
  .markdown-body { font-size: 0.95rem; }
  
  /* Profile stats hover disabled on mobile */
  #followersStat:hover, #followingStat:hover, #profilePageFollowersStat:hover, #profilePageFollowingStat:hover { transform: none; }
  
  /* Ensure ideas list has proper spacing */
  #ideasList { margin-bottom: 1rem; }
  
  /* Profile page spacing */
  #profilePage { margin-bottom: 1rem; }
}

/* Extra small screens */
@media (max-width: 480px) {
  body { padding: 0.75rem; padding-bottom: 85px; }
  h1 { font-size: 1.5rem; }
  
  .welcome-screen { 
    padding: 2rem 1rem; 
    margin: 1rem auto;
  }
  .welcome-screen h2 { font-size: 1.75rem; }
  .welcome-screen p { font-size: 1rem; }
  .welcome-screen .welcome-icon { font-size: 3rem; }
  
  .nav-link { 
    padding: 0.55rem 0.6rem;
    font-size: 0.7rem;
  }
  
  .card { padding: 0.9rem 1rem; }
  #ideaForm { padding: 1rem; }
  
  #topBar { 
    max-width: 120px;
    padding: 0.4rem;
  }
  #topBar label { font-size: 0.7rem; }
  
  #authButtons button { font-size: 1rem; padding: 0.8rem 1.2rem; }
  
  .profile-avatar-large { width: 60px; height: 60px; }
  .profile-stats { gap: 0.75rem; }
  
  #profileContent { padding: 1.2rem 1rem; }
  .modal-content { padding: 1rem; }
}
</style>
</head>
<body>

<h1>The Idea App</h1>

<div id="welcomeScreen" class="welcome-screen">
  <span class="welcome-icon">ðŸ’¡</span>
  <h2>Welcome to The Idea App</h2>
  <p>Share your ideas, connect with others, and discover amazing creations.<br>Sign in to get started!</p>
</div>

<section id="adminPanel">
  <h3>ðŸ”’ Admin Panel</h3>
  <div class="adminRow">
    <span class="adminBadge" id="adminUidBadge">UID: â€”</span>
    <button id="deleteAllBtn" class="danger">Delete ALL Ideas</button>
  </div>
  <small style="color:#6b7280;">Only visible to your admin account. Actions are immediate.</small>
</section>

<div id="authButtons">
  <button id="signInBtn">Sign In with Google</button>
</div>

<div id="topBar">
  <label>Background Color <input type="color" id="bgColorPicker" value="#f9fafb"></label>
  <label>Button Color <input type="color" id="btnColorPicker" value="#4f46e5"></label>
  <button id="signOutBtn">Sign Out</button>
  </div>

<div id="navBar" style="display:none;">
  <button class="nav-link active" id="navIdeas">Ideas</button>
  <button class="nav-link" id="navProfile">My Profile</button>
  <button class="nav-link" id="navSaved" style="display:none;">Saved</button>
  <button class="nav-link" id="navLeaderboard">Leaderboard</button>
</div>

 <div id="customization" style="display:none;"></div>

<div id="ideaForm" style="display:none;">
  <input id="ideaTitle" placeholder="Idea Title" />
  <textarea id="ideaDesc" rows="4" placeholder="Describe your idea in markdown..."></textarea>
  <button id="postIdea">Post Idea</button>
</div>

<div id="sortOptions" style="margin-bottom:1rem; text-align:center; display:none;">
  <label for="sortSelect">Sort by: </label>
  <select id="sortSelect">
    <option value="newest">Newest</option>
    <option value="mostReactions">Most Reactions</option>
    <option value="mostComments">Most Comments</option>
  </select>
</div>

<div id="ideasList"></div>

<div id="profilePage" style="display:none;"></div>

<!-- Profile Modal -->
<div id="profileModal">
  <div id="profileContent">
    <button id="closeProfile">Ã—</button>
    <div id="profileView">
      <div class="profile-header">
        <img id="profileAvatar" class="profile-avatar-large" src="" alt="Profile" />
        <div class="profile-info">
          <div class="profile-name" id="profileName">Loading...</div>
          <div class="profile-bio" id="profileBio">No bio yet.</div>
          <div class="profile-stats">
            <div class="profile-stat" style="cursor:default;">
              <div class="profile-stat-value" id="profileIdeasCount">0</div>
              <div class="profile-stat-label">Ideas</div>
            </div>
            <div class="profile-stat" id="followersStat" style="cursor:pointer; transition:transform .2s;">
              <div class="profile-stat-value" id="profileFollowersCount">0</div>
              <div class="profile-stat-label">Followers</div>
            </div>
            <div class="profile-stat" id="followingStat" style="cursor:pointer; transition:transform .2s;">
              <div class="profile-stat-value" id="profileFollowingCount">0</div>
              <div class="profile-stat-label">Following</div>
            </div>
          </div>
          <div class="profile-actions" id="profileActions"></div>
        </div>
      </div>
      <div id="profileIdeasList"></div>
    </div>
    <div id="profileEdit" style="display:none;">
      <h3>Edit Profile</h3>
      <label>Display Name:</label>
      <input id="profileDisplayNameEdit" placeholder="Your display name" />
      <!-- Removed manual photo upload; using preset avatars instead -->
      <div id="presetAvatarPicker" style="margin:.5rem 0; display:grid; grid-template-columns: repeat(6, 1fr); gap:.5rem;"></div>
      <label>Frame:</label>
      <div id="presetFramePicker" style="margin:.5rem 0; display:flex; gap:.5rem; flex-wrap:wrap;"></div>
      <label>Bio:</label>
      <textarea id="profileBioEdit" placeholder="Tell us about yourself..." style="min-height:80px;"></textarea>
      <button id="saveProfileBtn">Save Profile</button>
      <button class="secondary" id="cancelEditBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Followers/Following Modal -->
<div id="followersModal" class="modal">
  <div class="modal-content" style="max-width:400px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
      <h3 id="followersModalTitle" style="margin:0; color:var(--primary-dark);">Followers</h3>
      <button id="closeFollowersModal" class="button secondary" style="padding:.4rem .8rem;">âœ•</button>
    </div>
    <div id="followersList" style="max-height:400px; overflow-y:auto;">
      <!-- Follower/following users will be loaded here -->
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, arrayUnion, arrayRemove, deleteDoc, getDocs, getDoc, setDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAu2x0HdXxGiLv1Rhjqwv4Lkp2Wooo13L0",
  authDomain: "theideaapp-2ff99.firebaseapp.com",
  projectId: "theideaapp-2ff99",
  storageBucket: "theideaapp-2ff99.appspot.com",
  messagingSenderId: "964418361365",
  appId: "1:964418361365:web:44fd66314e75b4181e561c",
  measurementId: "G-FJQ0228EZK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt: 'select_account' });

// Handle redirect result immediately on page load (for mobile sign-in)
// This must be called before onAuthStateChanged
getRedirectResult(auth).then(async (result) => {
  if (result && result.user) {
    // User signed in via redirect - profile will be created/handled by onAuthStateChanged
    console.log("Redirect sign-in successful for:", result.user.email);
  }
}).catch((error) => {
  // Ignore auth errors that are normal when no redirect pending
  if (error.code !== 'auth/operation-not-allowed' && 
      error.code !== 'auth/internal-error' &&
      !error.message?.includes('No pending')) {
    console.error("Redirect sign-in error:", error);
  }
});

// Avatar helpers
function getAvatarSrcFromProfile(p){
  return (p?.avatarPreset) || (p?.photoURL) || "https://www.gravatar.com/avatar?d=mp&f=y";
}
function applyFrameClass(el, p){
  if (!el) return;
  el.classList.remove("avatar-frame","avatar-frame-gold","avatar-frame-rainbow","avatar-frame-neon","avatar-frame-dotted","avatar-frame-gradient","avatar-frame-blue","avatar-frame-pink","avatar-frame-glowpurple");
  const f = p?.framePreset;
  if (f === "default") el.classList.add("avatar-frame");
  if (f === "gold") el.classList.add("avatar-frame-gold");
  if (f === "rainbow") el.classList.add("avatar-frame-rainbow");
  if (f === "neon") el.classList.add("avatar-frame-neon");
  if (f === "dotted") el.classList.add("avatar-frame-dotted");
  if (f === "gradient") el.classList.add("avatar-frame-gradient");
  if (f === "blue") el.classList.add("avatar-frame-blue");
  if (f === "pink") el.classList.add("avatar-frame-pink");
  if (f === "glowpurple") el.classList.add("avatar-frame-glowpurple");
}

const ADMIN_UID = "x7GUnYJAeGg4qx68iZfT0Ns46EC3";
let isAdmin = false;
let currentUserProfile = null;
let viewingProfileUid = null;

// Get all DOM elements
const adminPanel = document.getElementById("adminPanel");
const adminUidBadge = document.getElementById("adminUidBadge");
const deleteAllBtn = document.getElementById("deleteAllBtn");
const ideasList = document.getElementById("ideasList");
const postBtn = document.getElementById("postIdea");
const ideaTitle = document.getElementById("ideaTitle");
const ideaDesc = document.getElementById("ideaDesc");
const signInBtn = document.getElementById("signInBtn");
const signOutBtn = document.getElementById("signOutBtn");
const topBar = document.getElementById("topBar");
const ideaForm = document.getElementById("ideaForm");
const bgColorPicker = document.getElementById("bgColorPicker");
const btnColorPicker = document.getElementById("btnColorPicker");
const profileModal = document.getElementById("profileModal");
const closeProfile = document.getElementById("closeProfile");
const navBar = document.getElementById("navBar");
const navIdeas = document.getElementById("navIdeas");
const navProfile = document.getElementById("navProfile");
const navSaved = document.getElementById("navSaved");
const navLeaderboard = document.getElementById("navLeaderboard");
const profileEdit = document.getElementById("profileEdit");
const profileBioEdit = document.getElementById("profileBioEdit");
const profileDisplayNameEdit = document.getElementById("profileDisplayNameEdit");
const presetAvatarPicker = document.getElementById("presetAvatarPicker");
const presetFramePicker = document.getElementById("presetFramePicker");
const profilePage = document.getElementById("profilePage");

// Preset avatars and frames
const PRESET_AVATARS = [
  // Bottts (robots)
  "https://api.dicebear.com/7.x/bottts/svg?seed=PixelPirate",
  "https://api.dicebear.com/7.x/bottts/svg?seed=NeonNinja",
  "https://api.dicebear.com/7.x/bottts/svg?seed=CyberCat",
  "https://api.dicebear.com/7.x/bottts/svg?seed=GalaxyGoose",
  "https://api.dicebear.com/7.x/bottts/svg?seed=SplendidShark",
  // Adventurer (cartoon people)
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SkyWalker",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=StarBlossom",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=MoonRider",
  // Thumbs (hands)
  "https://api.dicebear.com/7.x/thumbs/svg?seed=ThumbsUp",
  "https://api.dicebear.com/7.x/thumbs/svg?seed=Victory",
  // Fun Emoji
  "https://api.dicebear.com/7.x/fun-emoji/svg?seed=Sunshine",
  "https://api.dicebear.com/7.x/fun-emoji/svg?seed=Sparkle"
];
const PRESET_FRAMES = [
  { key: "none", label: "None", className: "" },
  { key: "default", label: "Primary", className: "avatar-frame" },
  { key: "gold", label: "Gold", className: "avatar-frame-gold" },
  { key: "rainbow", label: "Rainbow", className: "avatar-frame-rainbow" },
  { key: "neon", label: "Neon", className: "avatar-frame-neon" },
  { key: "dotted", label: "Dotted", className: "avatar-frame-dotted" },
  { key: "gradient", label: "Gradient", className: "avatar-frame-gradient" },
  { key: "blue", label: "Blue", className: "avatar-frame-blue" },
  { key: "pink", label: "Pink", className: "avatar-frame-pink" },
  { key: "glowpurple", label: "Glow Purple", className: "avatar-frame-glowpurple" }
];

let selectedAvatarPreset = null;
let selectedFramePreset = null;
const saveProfileBtn = document.getElementById("saveProfileBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const followersModal = document.getElementById("followersModal");
const closeFollowersModal = document.getElementById("closeFollowersModal");
const followersList = document.getElementById("followersList");
const followersModalTitle = document.getElementById("followersModalTitle");
const followersStat = document.getElementById("followersStat");
const followingStat = document.getElementById("followingStat");

// ---------------- Customization ----------------
// Namespaced localStorage keys per signed-in user (so themes don't leak across accounts)
function getThemeKey(name){
  const uid = (typeof auth !== 'undefined' && auth?.currentUser?.uid) ? auth.currentUser.uid : 'guest';
  return `ideaApp_${name}_${uid}`;
}

// Load saved colors for guest (will be overridden on sign-in with profile theme)
const savedBgColor = localStorage.getItem(getThemeKey("bgColor"));
const savedBtnColor = localStorage.getItem(getThemeKey("btnColor"));
if (savedBgColor) {
  document.body.style.backgroundColor = savedBgColor;
  if (bgColorPicker) bgColorPicker.value = savedBgColor;
}
if (savedBtnColor) {
  applyButtonColor(savedBtnColor);
  if (btnColorPicker) btnColorPicker.value = savedBtnColor;
}

 function applyButtonColor(val) {
   document.documentElement.style.setProperty("--accent", val);
   document.documentElement.style.setProperty("--button-bg", val);
   document.documentElement.style.setProperty("--primary", val);
   document.documentElement.style.setProperty("--primary-dark", shadeColor(val, -15));
   document.documentElement.style.setProperty("--button-bg-hover", shadeColor(val, -20));
   document.documentElement.style.setProperty("--button-shadow", hexToRgba(val, 0.4));
   document.documentElement.style.setProperty("--shadow-color", hexToRgba(val, 0.3));
 }

bgColorPicker.addEventListener("input", async e => { 
  const color = e.target.value;
  document.body.style.backgroundColor = color;
  localStorage.setItem(getThemeKey("bgColor"), color);
  if (auth.currentUser) {
    try { await updateDoc(doc(db, "profiles", auth.currentUser.uid), { themeBgColor: color }); await refreshCurrentUserProfile(); } catch (err) { console.error("Error saving bg color:", err); }
  }
});

btnColorPicker.addEventListener("input", async e => {
  const val = e.target.value;
  applyButtonColor(val);
  localStorage.setItem(getThemeKey("btnColor"), val);
  if (auth.currentUser) {
    try { await updateDoc(doc(db, "profiles", auth.currentUser.uid), { themeBtnColor: val }); await refreshCurrentUserProfile(); } catch (err) { console.error("Error saving btn color:", err); }
  }
});
function shadeColor(color, percent) {
  let R = parseInt(color.substring(1,3),16), G = parseInt(color.substring(3,5),16), B = parseInt(color.substring(5,7),16);
  R = Math.min(255, Math.max(0, parseInt(R*(100+percent)/100)));
  G = Math.min(255, Math.max(0, parseInt(G*(100+percent)/100)));
  B = Math.min(255, Math.max(0, parseInt(B*(100+percent)/100)));
  return "#" + [R,G,B].map(v=>v.toString(16).padStart(2,"0")).join("");
}
function hexToRgba(hex,a){ const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }

// ---------------- Profile Functions ----------------
async function getOrCreateProfile(uid, displayName, photoURL) {
  const profileRef = doc(db, "profiles", uid);
  let profileSnap;
  try {
    profileSnap = await getDoc(profileRef);
  } catch (err) {
    if (err.code === 'permission-denied') {
      console.error("Permission denied reading profile:", err);
      throw err;
    }
    throw err;
  }
  
  if (!profileSnap.exists()) {
    try {
      await setDoc(profileRef, {
        uid,
        displayName,
        photoURL,
        bio: "",
        followers: [],
        following: [],
        savedPosts: [],
        themeBgColor: localStorage.getItem("ideaApp_bgColor") || document.body.style.backgroundColor || "#f9fafb",
        themeBtnColor: localStorage.getItem("ideaApp_btnColor") || getComputedStyle(document.documentElement).getPropertyValue("--button-bg")?.trim() || "#4f46e5",
        handle: ("user_" + uid.slice(-6)),
        createdAt: serverTimestamp()
      });
    } catch (err) {
      if (err.code === 'permission-denied') {
        console.error("Permission denied creating profile:", err);
        throw err;
      }
      throw err;
    }
  } else {
    // Do NOT overwrite user's chosen displayName/photo on every sign-in.
    // Only backfill if missing.
    try {
      const existing = profileSnap.data();
      const updates = {};
      if (!existing.displayName && displayName) updates.displayName = displayName;
      if (!existing.photoURL && photoURL) updates.photoURL = photoURL;
      if (Object.keys(updates).length > 0) {
        await updateDoc(profileRef, updates);
      }
    } catch (err) {
      if (err.code === 'permission-denied') {
        console.error("Permission denied updating profile:", err);
        throw err;
      }
      throw err;
    }
  }
  const updatedSnap = await getDoc(profileRef);
  // Backfill handle if missing
  const data = updatedSnap.data();
  if (data && !data.handle) {
    try { await updateDoc(profileRef, { handle: ("user_" + uid.slice(-6)) }); } catch (e) {}
    const resnap = await getDoc(profileRef);
    return resnap.data();
  }
  return data;
}

async function followUser(targetUid) {
  if (!auth.currentUser || targetUid === auth.currentUser.uid) return;
  const userUid = auth.currentUser.uid;
  const userProfileRef = doc(db, "profiles", userUid);
  const targetProfileRef = doc(db, "profiles", targetUid);
  
  try {
    // First, ensure both profiles exist
    const userProfile = await getDoc(userProfileRef);
    const targetProfile = await getDoc(targetProfileRef);
    
    if (!userProfile.exists()) {
      // Create user profile if it doesn't exist
      await getOrCreateProfile(userUid, auth.currentUser.displayName, auth.currentUser.photoURL);
    }
    
    if (!targetProfile.exists()) {
      alert("The profile you're trying to follow doesn't exist.");
      return;
    }
    
    const userFollowing = (await getDoc(userProfileRef)).data()?.following || [];
    const isFollowing = userFollowing.includes(targetUid);
    
    // Update current user's following list (this should always work)
    try {
      if (isFollowing) {
        await updateDoc(userProfileRef, { following: arrayRemove(targetUid) });
      } else {
        await updateDoc(userProfileRef, { following: arrayUnion(targetUid) });
      }
    } catch (err) {
      console.error("Error updating own following list:", err);
      alert("Error updating your following list: " + err.message);
      return;
    }
    
    // Update target user's followers list (this might fail due to permissions)
    try {
      if (isFollowing) {
        await updateDoc(targetProfileRef, { followers: arrayRemove(userUid) });
      } else {
        await updateDoc(targetProfileRef, { followers: arrayUnion(userUid) });
      }
    } catch (err) {
      console.error("Error updating target followers list:", err);
      if (err.code === 'permission-denied') {
        alert("Permission denied: Cannot update follower count. Please check Firestore security rules to allow updating the 'followers' field on profiles.");
      } else {
        alert("Error updating follower count: " + err.message);
      }
      // Still update current user's profile even if target update fails
    }
    
    await refreshCurrentUserProfile();
  } catch (err) {
    console.error("Error following user:", err);
    if (err.code === 'permission-denied') {
      alert("Permission denied. Please check Firestore security rules. The rules need to allow:\n1. Users to update their own 'following' array\n2. Users to update any profile's 'followers' array");
    } else {
      alert("Error: " + err.message);
    }
  }
}

async function loadFollowersList(uid, type) {
  if (!uid) {
    console.error("No UID provided to loadFollowersList");
    alert("Error: No user ID provided");
    return;
  }
  
  if (!followersList || !followersModalTitle || !followersModal) {
    console.error("Followers modal elements not found");
    alert("Error: Page elements not loaded");
    return;
  }
  
  try {
    // Show loading state
    followersModalTitle.textContent = type === "followers" ? "Followers" : "Following";
    followersList.innerHTML = "<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>Loading...</p>";
    followersModal.classList.add("active");
    
    // Get the profile to access followers/following arrays
    const profileRef = doc(db, "profiles", uid);
    const profileSnap = await getDoc(profileRef);
    
    if (!profileSnap.exists()) {
      followersList.innerHTML = "<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>Profile not found.</p>";
      return;
    }
    
    const profile = profileSnap.data();
    const userIds = type === "followers" ? (profile.followers || []) : (profile.following || []);
    
    if (!Array.isArray(userIds)) {
      followersList.innerHTML = `<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>No ${type} yet.</p>`;
      return;
    }
    
    if (userIds.length === 0) {
      followersList.innerHTML = `<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>No ${type} yet.</p>`;
      return;
    }
    
    // Clear the list
    followersList.innerHTML = "";
    
    // Load each user's profile
    const userPromises = userIds.map(async (userId) => {
      if (!userId || typeof userId !== 'string') {
        return null;
      }
      try {
        const userProfileRef = doc(db, "profiles", userId);
        const userProfileSnap = await getDoc(userProfileRef);
        if (userProfileSnap.exists()) {
          const data = userProfileSnap.data();
          return { ...data, uid: userId }; // Ensure uid is included
        }
        return null;
      } catch (err) {
        console.error("Error loading user profile for userId:", userId, err);
        return null;
      }
    });
    
    const userProfiles = (await Promise.all(userPromises)).filter(p => p !== null && p.uid);
    
    if (userProfiles.length === 0) {
      followersList.innerHTML = `<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>No ${type} profiles found.</p>`;
      return;
    }
    
    // Display each user
    userProfiles.forEach(userProfile => {
      if (!userProfile.uid) return; // Skip if no uid
      
      const item = document.createElement("div");
      item.className = "follower-item";
      item.addEventListener("click", () => {
        followersModal.classList.remove("active");
        openProfileTab(userProfile.uid);
      });
      
      const avatar = document.createElement("img");
      avatar.src = getAvatarSrcFromProfile(userProfile) || ("https://ui-avatars.com/api/?name=" + encodeURIComponent(userProfile.displayName || "User") + "&background=4f46e5&color=fff");
      avatar.alt = userProfile.displayName || "User";
      avatar.onerror = () => { avatar.src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(userProfile.displayName || "User") + "&background=4f46e5&color=fff"; };
      applyFrameClass(avatar, userProfile);
      
      const info = document.createElement("div");
      info.className = "follower-item-info";
      
      const name = document.createElement("div");
      name.className = "follower-item-name";
      name.textContent = userProfile.displayName || "Unknown User";
      
      const bio = document.createElement("div");
      bio.className = "follower-item-bio";
      bio.textContent = (userProfile.bio || "").substring(0, 100) || "No bio yet.";
      if (userProfile.bio && userProfile.bio.length > 100) {
        bio.textContent += "...";
      }
      
      info.appendChild(name);
      info.appendChild(bio);
      item.appendChild(avatar);
      item.appendChild(info);
      followersList.appendChild(item);
    });
  } catch (err) {
    console.error("Error loading followers/following:", err);
    const errorMsg = err.message || "Unknown error occurred";
    followersList.innerHTML = `<p style='text-align:center; color:#dc2626; padding:2rem;'>Error loading ${type}: ${errorMsg}</p>`;
  }
}

async function loadProfile(uid) {
  if (!uid) {
    console.error("No UID provided to loadProfile");
    alert("No user ID provided");
    return;
  }
  
  console.log("Loading profile for UID:", uid);
  viewingProfileUid = uid;
  
  try {
    let profileRef = doc(db, "profiles", uid);
    let profileSnap;
    
    try {
      profileSnap = await getDoc(profileRef);
    } catch (err) {
      if (err.code === 'permission-denied') {
        alert("Permission denied. Please check Firestore security rules. Profiles collection needs read access.");
        console.error("Firestore permission error:", err);
        return;
      }
      throw err;
    }
    
    if (!profileSnap.exists()) {
      const user = auth.currentUser;
      if (user && user.uid === uid) {
        try {
          await getOrCreateProfile(uid, user.displayName, user.photoURL);
          profileSnap = await getDoc(profileRef);
        } catch (err) {
          if (err.code === 'permission-denied') {
            alert("Permission denied. Cannot create profile. Please check Firestore security rules.");
            console.error("Firestore permission error:", err);
            return;
          }
          throw err;
        }
      } else {
        try {
          await setDoc(profileRef, {
            uid,
            displayName: "User",
            photoURL: "",
            bio: "",
            followers: [],
            following: [],
            createdAt: serverTimestamp()
          });
          profileSnap = await getDoc(profileRef);
        } catch (err) {
          if (err.code === 'permission-denied') {
            alert("Permission denied. Cannot create profile. Please check Firestore security rules.");
            console.error("Firestore permission error:", err);
            return;
          }
          throw err;
        }
      }
    }
    
    const profile = profileSnap.data();
    console.log("Profile loaded:", profile);
    
    // Get user's ideas
    let userIdeas = [];
    try {
      const ideasQuery = query(collection(db, "ideas"), where("uid", "==", uid), orderBy("created", "desc"));
      const ideasSnapshot = await getDocs(ideasQuery);
      userIdeas = ideasSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (err) {
      console.warn("Query failed, filtering manually:", err);
      const allIdeasSnap = await getDocs(collection(db, "ideas"));
      userIdeas = allIdeasSnap.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .filter(idea => idea.uid === uid)
        .sort((a, b) => {
          const aDate = a.created?.toDate ? a.created.toDate() : new Date(a.created);
          const bDate = b.created?.toDate ? b.created.toDate() : new Date(b.created);
          return bDate - aDate;
        });
    }
    
    // Update profile modal UI
    const profileNameEl = document.getElementById("profileName");
    profileNameEl.innerHTML = profile.displayName || "Anonymous";
    
    const existingBadge = profileNameEl.querySelector(".devBadge");
    if (profile.uid === ADMIN_UID) {
      if (!existingBadge) {
        const badge = document.createElement("span");
        badge.className = "devBadge";
        badge.textContent = "Developer";
        badge.style.marginLeft = "8px";
        profileNameEl.appendChild(badge);
      }
    } else if (existingBadge) {
      existingBadge.remove();
    }
    
    const profileAvatarEl = document.getElementById("profileAvatar");
    profileAvatarEl.src = getAvatarSrcFromProfile(profile);
    applyFrameClass(profileAvatarEl, profile);
    profileAvatarEl.onerror = () => { profileAvatarEl.src = "https://www.gravatar.com/avatar?d=mp&f=y"; };
    document.getElementById("profileBio").textContent = profile.bio || "No bio yet.";
    // Show immutable handle under name
    const handleElId = "profileHandleInline";
    const existingHandle = document.getElementById(handleElId);
    const handleText = profile.handle ? ("@" + profile.handle) : ("@user_" + (profile.uid || "").slice(-6));
    if (!existingHandle) {
      const handleEl = document.createElement("div");
      handleEl.id = handleElId;
      handleEl.style.color = "var(--text-secondary)";
      handleEl.style.marginTop = "-0.25rem";
      handleEl.style.marginBottom = "0.5rem";
      handleEl.style.fontSize = "0.9rem";
      handleEl.textContent = handleText;
      document.querySelector(".profile-info .profile-name").insertAdjacentElement("afterend", handleEl);
    } else {
      existingHandle.textContent = handleText;
    }
    document.getElementById("profileIdeasCount").textContent = userIdeas.length;
    document.getElementById("profileFollowersCount").textContent = (profile.followers || []).length;
    document.getElementById("profileFollowingCount").textContent = (profile.following || []).length;
    
    // Profile actions
    const actionsDiv = document.getElementById("profileActions");
    actionsDiv.innerHTML = "";
    
    if (auth.currentUser && uid === auth.currentUser.uid) {
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit Profile";
      editBtn.onclick = () => {
        document.getElementById("profileView").style.display = "none";
        profileEdit.style.display = "block";
        profileBioEdit.value = profile.bio || "";
        if (profileDisplayNameEdit) profileDisplayNameEdit.value = profile.displayName || "";
        // Render presets
        if (presetAvatarPicker) {
          presetAvatarPicker.innerHTML = "";
          PRESET_AVATARS.forEach(url => {
            const btn = document.createElement("button");
            btn.style.padding = 0; btn.style.border = "2px solid transparent"; btn.style.borderRadius = "50%"; btn.style.overflow = "hidden"; btn.style.width = "40px"; btn.style.height = "40px";
            const img = document.createElement("img"); img.src = url; img.style.width = "40px"; img.style.height = "40px"; img.style.objectFit = "cover"; img.alt = "preset";
            btn.appendChild(img);
            btn.addEventListener("click", () => {
              selectedAvatarPreset = url;
              // Visual selection
              Array.from(presetAvatarPicker.children).forEach(c => c.style.borderColor = "transparent");
              btn.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue("--primary");
            });
            presetAvatarPicker.appendChild(btn);
          });
          // Preselect existing preset if any
          selectedAvatarPreset = profile.avatarPreset || null;
          if (selectedAvatarPreset) {
            Array.from(presetAvatarPicker.children).forEach(c => { const img=c.querySelector('img'); if (img && img.src===selectedAvatarPreset) c.style.borderColor=getComputedStyle(document.documentElement).getPropertyValue("--primary"); });
          }
        }
        if (presetFramePicker) {
          presetFramePicker.innerHTML = "";
          PRESET_FRAMES.forEach(fr => {
            const btn = document.createElement("button");
            btn.className = fr.className;
            btn.style.width = "48px"; btn.style.height = "48px"; btn.style.borderRadius = "50%"; btn.style.position = "relative"; btn.style.background = "#e5e7eb"; btn.style.border = "2px solid transparent";
            const dot = document.createElement("div"); dot.style.width = "100%"; dot.style.height = "100%"; dot.style.borderRadius = "50%"; dot.style.background = "#fff"; btn.appendChild(dot);
            btn.title = fr.label;
            btn.addEventListener("click", () => {
              selectedFramePreset = fr.key;
              Array.from(presetFramePicker.children).forEach(c => c.style.borderColor = "transparent");
              btn.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue("--primary");
            });
            presetFramePicker.appendChild(btn);
          });
          selectedFramePreset = profile.framePreset || "none";
        }
      };
      actionsDiv.appendChild(editBtn);
    } else if (auth.currentUser) {
      const isFollowing = (currentUserProfile?.following || []).includes(uid);
      const followBtn = document.createElement("button");
      followBtn.textContent = isFollowing ? "Following" : "Follow";
      followBtn.className = isFollowing ? "secondary" : "";
      followBtn.onclick = async () => {
        await followUser(uid);
        await loadProfile(uid);
      };
      actionsDiv.appendChild(followBtn);
    }
    
    // Render user's ideas
    const ideasListDiv = document.getElementById("profileIdeasList");
    ideasListDiv.innerHTML = "";
    if (userIdeas.length === 0) {
      ideasListDiv.innerHTML = "<p style='text-align:center; color:var(--text-secondary); padding:2rem;'>No ideas yet.</p>";
    } else {
      userIdeas.forEach(idea => {
        const ideaCard = document.createElement("div");
        ideaCard.className = "profile-idea-card";
        ideaCard.innerHTML = `
          <h4>${escapeHtml(idea.title || "")}</h4>
          <div class="markdown-body" style="font-size:0.9rem; margin-bottom:0.5rem;">${markdownToHTML(idea.description || "")}</div>
          <div class="idea-time">${formatDate(idea.created)}</div>
        `;
        ideasListDiv.appendChild(ideaCard);
      });
    }
    
    // Show the modal - THIS IS THE KEY FIX
    console.log("Showing modal");
    profileModal.classList.add("active");
    console.log("Modal classes:", profileModal.className);
  } catch (err) {
    console.error("Error loading profile:", err);
    alert("Error loading profile: " + err.message);
  }
}

function escapeHtml(text) {
  if (!text) return "";
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function renderProfilePage(uid) {
  try {
    if (ideaForm) ideaForm.style.display = "none";
    if (profilePage) { profilePage.style.display = "block"; profilePage.innerHTML = "Loading profile..."; }
    // Fetch profile and user's ideas
    const profileRef = doc(db, "profiles", uid);
    let profileSnap = await getDoc(profileRef);
    if (!profileSnap.exists()) {
      profilePage.innerHTML = "<p style='color:var(--text-secondary); text-align:center; padding:2rem;'>Profile not found.</p>";
      return;
    }
    const profile = profileSnap.data();
    let userIdeas = [];
    try {
      const q = query(collection(db, "ideas"), where("uid", "==", uid), orderBy("created", "desc"));
      const snap = await getDocs(q);
      userIdeas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (e) {
      const all = await getDocs(collection(db, "ideas"));
      userIdeas = all.docs.map(d => ({ id: d.id, ...d.data() })).filter(i => i.uid === uid)
        .sort((a,b) => (b.created?.toDate ? b.created.toDate() : new Date(b.created)) - (a.created?.toDate ? a.created.toDate() : new Date(a.created)));
    }

    // Build page
    const container = document.createElement("div");
    container.innerHTML = `
      <div class="profile-header">
        <img id="profilePageAvatar" class="profile-avatar-large" src="" alt="Profile" />
        <div class="profile-info">
          <div class="profile-name">${escapeHtml(profile.displayName || "Anonymous")}</div>
          <div class="profile-bio">${escapeHtml(profile.bio || "No bio yet.")}</div>
          <div class="profile-stats">
            <div class="profile-stat" style="cursor:default;"><div class="profile-stat-value">${userIdeas.length}</div><div class="profile-stat-label">Ideas</div></div>
            <div class="profile-stat" id="profilePageFollowersStat" style="cursor:pointer; transition:transform .2s;"><div class="profile-stat-value">${(profile.followers||[]).length}</div><div class="profile-stat-label">Followers</div></div>
            <div class="profile-stat" id="profilePageFollowingStat" style="cursor:pointer; transition:transform .2s;"><div class="profile-stat-value">${(profile.following||[]).length}</div><div class="profile-stat-label">Following</div></div>
          </div>
          <div class="profile-actions" id="profilePageActions"></div>
        </div>
      </div>
      <div id="profilePageIdeas"></div>
    `;

    profilePage.innerHTML = "";
    profilePage.appendChild(container);

    // Add click handlers for followers/following stats
    const followersStatEl = document.getElementById("profilePageFollowersStat");
    const followingStatEl = document.getElementById("profilePageFollowingStat");
    if (followersStatEl) {
      followersStatEl.addEventListener("click", () => {
        viewingProfileUid = uid;
        loadFollowersList(uid, "followers");
      });
      followersStatEl.addEventListener("mouseenter", () => {
        followersStatEl.style.transform = "scale(1.05)";
      });
      followersStatEl.addEventListener("mouseleave", () => {
        followersStatEl.style.transform = "scale(1)";
      });
    }
    if (followingStatEl) {
      followingStatEl.addEventListener("click", () => {
        viewingProfileUid = uid;
        loadFollowersList(uid, "following");
      });
      followingStatEl.addEventListener("mouseenter", () => {
        followingStatEl.style.transform = "scale(1.05)";
      });
      followingStatEl.addEventListener("mouseleave", () => {
        followingStatEl.style.transform = "scale(1)";
      });
    }

    // Apply avatar + frame
    const avatarEl = document.getElementById("profilePageAvatar");
    avatarEl.src = getAvatarSrcFromProfile(profile);
    applyFrameClass(avatarEl, profile);
    avatarEl.onerror = () => { avatarEl.src = "https://www.gravatar.com/avatar?d=mp&f=y"; };

    // Actions
    const actionsDiv = document.getElementById("profilePageActions");
    if (auth.currentUser && uid === auth.currentUser.uid) {
      const editBtn = document.createElement("button"); editBtn.textContent = "Edit Profile";
      editBtn.onclick = () => { profileModal.classList.add("active"); document.getElementById("profileView").style.display = "block"; profileEdit.style.display = "none"; loadProfile(uid); };
      actionsDiv.appendChild(editBtn);
    } else if (auth.currentUser) {
      const isFollowing = (currentUserProfile?.following || []).includes(uid);
      const followBtn = document.createElement("button");
      followBtn.textContent = isFollowing ? "Following" : "Follow";
      followBtn.className = isFollowing ? "secondary" : "";
      followBtn.onclick = async () => { await followUser(uid); await renderProfilePage(uid); };
      actionsDiv.appendChild(followBtn);
    }

    // Ideas list
    const listDiv = document.getElementById("profilePageIdeas");
    if (!userIdeas.length) {
      listDiv.innerHTML = "<p style='color:var(--text-secondary); text-align:center; padding:2rem;'>No ideas yet.</p>";
    } else {
      userIdeas.forEach(i => {
        const card = document.createElement("div");
        card.className = "profile-idea-card";
        card.innerHTML = `<h4>${escapeHtml(i.title||"")}</h4><div class="markdown-body" style="font-size:0.9rem; margin-bottom:0.5rem;">${markdownToHTML(i.description||"")}</div><div class="idea-time">${formatDate(i.created)}</div>`;
        listDiv.appendChild(card);
      });
    }
    // Show profile page and hide ideas list
    if (document.getElementById("ideasList")) document.getElementById("ideasList").style.display = "none";
    if (document.getElementById("sortOptions")) document.getElementById("sortOptions").style.display = "none";
  } catch (e) {
    console.error("Error rendering profile page:", e);
    if (profilePage) profilePage.innerHTML = `<p style='color:#dc2626; text-align:center; padding:2rem;'>Error loading profile: ${e.message||"Unknown error"}</p>`;
  }
}

function openProfileTab(uid){
  navIdeas.classList.remove("active");
  navSaved?.classList.remove("active");
  navLeaderboard?.classList.remove("active");
  navProfile.classList.add("active");
  if (ideaForm) ideaForm.style.display = "none";
  renderProfilePage(uid);
}

async function refreshCurrentUserProfile() {
  if (auth.currentUser) {
    try {
      currentUserProfile = await getOrCreateProfile(
        auth.currentUser.uid,
        auth.currentUser.displayName,
        auth.currentUser.photoURL
      );
      const profileSnap = await getDoc(doc(db, "profiles", auth.currentUser.uid));
      if (profileSnap.exists()) {
        currentUserProfile = profileSnap.data();
      }
      if (currentUserProfile) {
        if (currentUserProfile.themeBgColor) {
          document.body.style.backgroundColor = currentUserProfile.themeBgColor;
          if (bgColorPicker) bgColorPicker.value = currentUserProfile.themeBgColor;
        }
        if (currentUserProfile.themeBtnColor) {
          applyButtonColor(currentUserProfile.themeBtnColor);
          if (btnColorPicker) btnColorPicker.value = currentUserProfile.themeBtnColor;
        }
        if (navSaved) navSaved.style.display = "inline-block";
      }
    } catch (err) {
      console.error("Error refreshing profile:", err);
    }
  }
}

// Profile modal event handlers - CRITICAL FIXES
closeProfile.addEventListener("click", () => {
  profileModal.classList.remove("active");
  document.getElementById("profileView").style.display = "block";
  profileEdit.style.display = "none";
});

profileModal.addEventListener("click", (e) => {
  if (e.target === profileModal) {
    profileModal.classList.remove("active");
    document.getElementById("profileView").style.display = "block";
    profileEdit.style.display = "none";
  }
});

saveProfileBtn.addEventListener("click", async () => {
  if (!auth.currentUser) return;
  try {
    const updates = {};
    const bio = (profileBioEdit?.value || "").trim();
    updates.bio = bio;
    const displayName = (profileDisplayNameEdit?.value || "").trim();
    if (displayName) updates.displayName = displayName;
    if (selectedAvatarPreset) updates.avatarPreset = selectedAvatarPreset;
    if (selectedFramePreset !== null) updates.framePreset = selectedFramePreset;

    await updateDoc(doc(db, "profiles", auth.currentUser.uid), updates);
    profileEdit.style.display = "none";
    document.getElementById("profileView").style.display = "block";
    await refreshCurrentUserProfile();
    await loadProfile(auth.currentUser.uid);
    // Re-render ideas lists so author/avatar reflect new profile
    const savedActive = document.getElementById("navSaved")?.classList.contains("active");
    if (savedActive) renderSavedIdeas(); else renderAllIdeas();
  } catch (err) {
    alert("Error saving profile: " + err.message);
  }
});

cancelEditBtn.addEventListener("click", () => {
  profileEdit.style.display = "none";
  document.getElementById("profileView").style.display = "block";
});

// Followers/Following event listeners
followersStat.addEventListener("click", () => {
  if (viewingProfileUid) {
    loadFollowersList(viewingProfileUid, "followers");
  }
});

followingStat.addEventListener("click", () => {
  if (viewingProfileUid) {
    loadFollowersList(viewingProfileUid, "following");
  }
});

closeFollowersModal.addEventListener("click", () => {
  followersModal.classList.remove("active");
});

followersModal.addEventListener("click", (e) => {
  if (e.target === followersModal) {
    followersModal.classList.remove("active");
  }
});

// Navigation handlers - CRITICAL FIXES
navIdeas.addEventListener("click", () => {
  console.log("Ideas nav clicked");
  navIdeas.classList.add("active");
  navProfile.classList.remove("active");
  if (navSaved) navSaved.classList.remove("active");
  if (navLeaderboard) navLeaderboard.classList.remove("active");
  document.getElementById("sortOptions").style.display = "block";
  document.getElementById("ideasList").style.display = "flex";
  if (profilePage) profilePage.style.display = "none";
  if (ideaForm) ideaForm.style.display = "block";
  profileModal.classList.remove("active");
  renderAllIdeas();
});

navProfile.addEventListener("click", async () => {
  console.log("Profile nav clicked");
  if (!auth.currentUser) {
    alert("Please sign in to view your profile");
    return;
  }
  navIdeas.classList.remove("active");
  navProfile.classList.add("active");
  if (navSaved) navSaved.classList.remove("active");
  if (navLeaderboard) navLeaderboard.classList.remove("active");
  document.getElementById("sortOptions").style.display = "none";
  document.getElementById("ideasList").style.display = "none";
  if (ideaForm) ideaForm.style.display = "none";
  if (!auth.currentUser) return;
  console.log("Loading profile tab for user:", auth.currentUser.uid);
  await renderProfilePage(auth.currentUser.uid);
});

// Saved tab handler
if (navSaved) {
  navSaved.addEventListener("click", () => {
    if (!auth.currentUser) {
      alert("Please sign in to view saved posts");
      return;
    }
    navIdeas.classList.remove("active");
    navProfile.classList.remove("active");
    navSaved.classList.add("active");
    if (navLeaderboard) navLeaderboard.classList.remove("active");
    document.getElementById("sortOptions").style.display = "none";
    document.getElementById("ideasList").style.display = "flex";
    if (profilePage) profilePage.style.display = "none";
    if (ideaForm) ideaForm.style.display = "none";
    profileModal.classList.remove("active");
    renderSavedIdeas();
  });
}

// Leaderboard tab handler
if (navLeaderboard) {
  navLeaderboard.addEventListener("click", () => {
    navIdeas.classList.remove("active");
    navProfile.classList.remove("active");
    if (navSaved) navSaved.classList.remove("active");
    navLeaderboard.classList.add("active");
    document.getElementById("sortOptions").style.display = "none";
    document.getElementById("ideasList").style.display = "flex";
  if (profilePage) profilePage.style.display = "none";
  if (ideaForm) ideaForm.style.display = "none";
    profileModal.classList.remove("active");
    renderLeaderboard();
  });
}

// Helper to detect mobile devices
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
         (window.innerWidth <= 768 && window.innerHeight <= 1024);
}

// ---------------- Auth ----------------
signInBtn.addEventListener("click", async ()=>{ 
  try{ 
    if (isMobileDevice()) {
      // Use redirect on mobile devices
      await signInWithRedirect(auth, provider);
      // Page will redirect, so code below won't run until redirect completes
    } else {
      // Use popup on desktop
      await signInWithPopup(auth, provider); 
    }
  } catch(e){ 
    // Only show error if it's not a redirect (redirect throws an error but that's expected)
    if (e.code !== 'auth/redirect-cancelled-by-user' && e.code !== 'auth/redirect-operation-pending') {
      alert("Sign-in failed: "+e.message); 
    }
  } 
});

signOutBtn.addEventListener("click", async ()=>{ 
  try{ 
    await signOut(auth); 
    profileModal.classList.remove("active");
    if (profilePage) profilePage.style.display = "none";
  } catch(e){ 
    alert("Sign-out failed: "+e.message); 
  } 
});

onAuthStateChanged(auth, async user=>{
  console.log("Auth state changed:", user ? "User signed in" : "User signed out", user?.uid);
  if(user){
    signInBtn.style.display="none"; 
    if (topBar) topBar.style.display = "flex";
    ideaForm.style.display="block"; 
    navBar.style.display="flex";
    // Hide welcome screen when signed in
    const welcomeScreen = document.getElementById("welcomeScreen");
    if (welcomeScreen) welcomeScreen.style.display = "none";
    isAdmin = (user.uid === ADMIN_UID);
    adminPanel.style.display = isAdmin ? "block":"none";
    adminUidBadge.textContent = "UID: "+user.uid;
    try {
      await getOrCreateProfile(user.uid, user.displayName, user.photoURL);
      await refreshCurrentUserProfile();
    } catch (err) {
      console.error("Error in auth state change:", err);
    }
    // Persist current theme to per-user localStorage keys
    if (currentUserProfile) {
      if (currentUserProfile.themeBgColor) {
        localStorage.setItem(getThemeKey("bgColor"), currentUserProfile.themeBgColor);
      }
      if (currentUserProfile.themeBtnColor) {
        localStorage.setItem(getThemeKey("btnColor"), currentUserProfile.themeBtnColor);
      }
    }
    if (navSaved) navSaved.style.display = "inline-block";
    const ideasDiv = document.getElementById("ideasList");
    if (ideasDiv) ideasDiv.style.display = "flex";
    renderAllIdeas();
  } else {
    signInBtn.style.display="inline-block"; 
    if (topBar) topBar.style.display = "none";
    ideaForm.style.display="none"; 
    navBar.style.display="none";
    isAdmin=false; 
    adminPanel.style.display="none";
    currentUserProfile = null;
    if (navSaved) navSaved.style.display = "none";
    // Show welcome screen and hide sort options
    const welcomeScreen = document.getElementById("welcomeScreen");
    if (welcomeScreen) welcomeScreen.style.display = "block";
    const sortOptions = document.getElementById("sortOptions");
    if (sortOptions) sortOptions.style.display = "none";
    // Reset theme to defaults on sign-out so themes don't leak across users
    document.body.style.backgroundColor = "#f9fafb";
    if (bgColorPicker) bgColorPicker.value = "#f9fafb";
    applyButtonColor("#4f46e5");
    if (btnColorPicker) btnColorPicker.value = "#4f46e5";
    const ideasDiv = document.getElementById("ideasList");
    if (ideasDiv) { ideasDiv.innerHTML = ""; ideasDiv.style.display = "none"; }
  }
});

// ---------------- Admin Actions ----------------
deleteAllBtn.addEventListener("click", async ()=>{
  if(!isAdmin) return;
  if(!confirm("âš ï¸ Delete ALL ideas?")) return;
  try{
    const qsnap = await getDocs(collection(db,"ideas"));
    const ops = []; qsnap.forEach(d=>ops.push(deleteDoc(doc(db,"ideas",d.id))));
    await Promise.all(ops);
    alert("All ideas deleted.");
  }catch(err){ alert("Error deleting all ideas: "+err.message); }
});

// ---------------- Posting Idea ----------------
if (postBtn) {
  postBtn.addEventListener("click", async ()=>{
    if(!auth.currentUser) return alert("Please sign in first!");
    const title = ideaTitle.value.trim(), desc = ideaDesc.value.trim();
    if(!title || !desc) return alert("Fill out both fields!");
    try{
      const authorName = (currentUserProfile?.displayName) || auth.currentUser.displayName;
      const authorAvatar = (currentUserProfile?.photoURL) || auth.currentUser.photoURL;
      await addDoc(collection(db,"ideas"),{
        title, description: desc,
        author: authorName,
        avatar: authorAvatar,
        uid: auth.currentUser.uid,
        reactions:{}, comments:[], created:new Date()
      });
      ideaTitle.value=""; ideaDesc.value="";
    }catch(err){ alert("Error posting idea: "+err.message); }
  });
}

// ---------------- Render Ideas ----------------
const ideasQuery = query(collection(db,"ideas"), orderBy("created","desc"));
let allIdeas = [];
let currentReactionMenu = null;
let profilesCache = new Map();

onSnapshot(ideasQuery, snapshot=>{
  allIdeas = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
  renderAllIdeas();
}, err => {
  console.error("Error listening to ideas:", err);
});

// Listen to profiles to keep names/avatars fresh
onSnapshot(collection(db, "profiles"), snap => {
  profilesCache = new Map();
  snap.docs.forEach(d => { const p = d.data(); if (p && (p.uid || d.id)) { profilesCache.set(p.uid || d.id, p); } });
  // Re-render if we are on ideas or saved tab so names/avatars update live
  const savedActive = document.getElementById("navSaved")?.classList.contains("active");
  const profileActive = document.getElementById("navProfile")?.classList.contains("active");
  if (!profileActive) {
    if (savedActive) renderSavedIdeas(); else renderAllIdeas();
  }
}, err => { console.error("Error listening to profiles:", err); });

const sortSelect = document.getElementById("sortSelect");
if (sortSelect) {
  sortSelect.addEventListener("change", renderAllIdeas);
}

function renderAllIdeas(){
  let sortedIdeas = [...allIdeas];
  switch(sortSelect?.value){
    case "mostReactions":
      sortedIdeas.sort((a,b)=>getTotalReactions(b.reactions)-getTotalReactions(a.reactions)); break;
    case "mostComments":
      sortedIdeas.sort((a,b)=>(b.comments?.length||0)-(a.comments?.length||0)); break;
    case "newest":
    default:
      // Sort by post creation date, NOT comment dates
      sortedIdeas.sort((a,b)=> {
        // Use the idea's created timestamp, ignore any comment timestamps
        const aDate = a.created?.toDate ? a.created.toDate() : (a.created ? new Date(a.created) : new Date(0));
        const bDate = b.created?.toDate ? b.created.toDate() : (b.created ? new Date(b.created) : new Date(0));
        return bDate.getTime() - aDate.getTime(); // Newest first
      });
      break;
  }
  if (ideasList) {
    ideasList.innerHTML="";
    sortedIdeas.forEach(renderIdea);
  }
}

function renderSavedIdeas(){
  if (!ideasList) return;
  const saved = (currentUserProfile?.savedPosts)||[];
  const savedSet = new Set(Array.isArray(saved)?saved:[]);
  const savedIdeas = allIdeas.filter(i=>savedSet.has(i.id));
  ideasList.innerHTML = "";
  if (savedIdeas.length === 0) {
    const empty = document.createElement("div");
    empty.style.color = "var(--text-secondary)";
    empty.style.textAlign = "center";
    empty.style.padding = "2rem";
    empty.textContent = "No saved posts yet.";
    ideasList.appendChild(empty);
    return;
  }
  savedIdeas.forEach(renderIdea);
}

// ---------------- Leaderboard ----------------
async function renderLeaderboard(){
  if (!ideasList) return;
  ideasList.innerHTML = "";
  try {
    // Build post and reaction counts from current idea snapshot
    const postCounts = new Map(); // uid -> count
    const reactionCounts = new Map(); // uid -> total reactions across their posts
    allIdeas.forEach(idea => {
      const uid = idea.uid;
      if (!uid) return;
      postCounts.set(uid, (postCounts.get(uid)||0) + 1);
      const reactions = getTotalReactions(idea.reactions);
      reactionCounts.set(uid, (reactionCounts.get(uid)||0) + reactions);
    });

    // Fetch profiles for names/avatars and follower counts
    const profilesSnap = await getDocs(collection(db, "profiles"));
    const profiles = profilesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    const followerCounts = new Map(); // uid -> followers length
    const uidToProfile = new Map();
    profiles.forEach(p => {
      followerCounts.set(p.uid || p.id, Array.isArray(p.followers) ? p.followers.length : 0);
      uidToProfile.set(p.uid || p.id, p);
    });

    // Helpers to create sections
    const container = document.createElement("div");
    container.style.display = "flex";
    container.style.flexDirection = "column";
    container.style.gap = "1rem";

    function createSection(title, rows){
      const section = document.createElement("div");
      section.className = "card";
      const h = document.createElement("h3"); h.textContent = title; section.appendChild(h);
      const list = document.createElement("div");
      rows.slice(0,5).forEach((row, idx) => {
        const item = document.createElement("div");
        item.style.display = "flex";
        item.style.alignItems = "center";
        item.style.justifyContent = "space-between";
        item.style.padding = ".5rem 0";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = ".6rem";
        const rank = document.createElement("span"); rank.textContent = String(idx+1) + "."; rank.style.minWidth = "1.5rem";
        const avatar = document.createElement("img"); avatar.style.width = "28px"; avatar.style.height = "28px"; avatar.style.borderRadius = "50%"; avatar.style.cursor = "pointer";
        avatar.src = getAvatarSrcFromProfile(row);
        avatar.alt = (row.displayName||"User") + " avatar";
        avatar.addEventListener("click", () => { if (row.uid) loadProfile(row.uid); });
        applyFrameClass(avatar, row);
        const name = document.createElement("span"); name.textContent = row.displayName || "User"; name.style.cursor = "pointer"; name.addEventListener("click", () => { if (row.uid) loadProfile(row.uid); });
        left.appendChild(rank); left.appendChild(avatar); left.appendChild(name);

        const right = document.createElement("div");
        right.style.fontWeight = "700";
        right.textContent = row.valueLabel;

        item.appendChild(left); item.appendChild(right);
        list.appendChild(item);
      });
      section.appendChild(list);
      return section;
    }

    // Build rows
    function topFromMap(countMap, label, valueSuffix){
      const rows = Array.from(countMap.entries())
        .sort((a,b)=>b[1]-a[1])
        .map(([uid, value]) => {
          const p = uidToProfile.get(uid) || { uid, displayName: "User", photoURL: "", avatarPreset: null, framePreset: null };
          return { uid, displayName: p.displayName || "User", photoURL: p.photoURL || "", avatarPreset: p.avatarPreset || null, framePreset: p.framePreset || null, value, valueLabel: `${value} ${valueSuffix}` };
        })
        .slice(0,5);
      return rows;
    }

    const postsRows = topFromMap(postCounts, "Most Posts", "posts");
    const reactionsRows = topFromMap(reactionCounts, "Most Reactions", "reactions");
    const followersRows = topFromMap(followerCounts, "Most Followers", "followers");

    container.appendChild(createSection("Most Posts", postsRows));
    container.appendChild(createSection("Most Reactions", reactionsRows));
    container.appendChild(createSection("Most Followers", followersRows));

    ideasList.appendChild(container);
  } catch (err) {
    console.error("Error rendering leaderboard:", err);
    const error = document.createElement("div");
    error.style.color = "#dc2626";
    error.style.textAlign = "center";
    error.style.padding = "2rem";
    error.textContent = "Error loading leaderboard: " + (err.message || "Unknown error");
    ideasList.appendChild(error);
  }
}

// ---------------- Render Single Idea ----------------
function renderIdea(idea){
  const card = document.createElement("article"); 
  card.className="card";

  const h3 = document.createElement("h3"); 
  h3.textContent=idea.title || ""; 
  card.appendChild(h3);

  const time = document.createElement("div"); 
  time.className="posted-time"; 
  time.textContent=formatDate(idea.created); 
  card.appendChild(time);

  const authorDiv = document.createElement("div"); 
  authorDiv.className="author";
  
  const profileForIdea = idea.uid ? (profilesCache.get(idea.uid) || null) : null;
  const avatar = document.createElement("img"); 
  const avatarSrc = (profileForIdea ? getAvatarSrcFromProfile(profileForIdea) : (idea.avatar || "https://www.gravatar.com/avatar?d=mp&f=y"));
  avatar.src = avatarSrc; 
  avatar.alt=(idea.author||"Anonymous")+" avatar";
  avatar.style.cursor = "pointer";
  applyFrameClass(avatar, profileForIdea);
  // CRITICAL FIX - Make avatar clickable
  avatar.addEventListener("click", (e) => {
    e.stopPropagation();
    console.log("Avatar clicked for UID:", idea.uid);
    if (idea.uid) {
      openProfileTab(idea.uid);
    } else {
      alert("No user ID available");
    }
  });
  authorDiv.appendChild(avatar);
  
  const authorName = document.createElement("span");
  authorName.textContent = (profileForIdea?.displayName) || idea.author || "Anonymous";
  authorName.style.cursor = "pointer";
  // CRITICAL FIX - Make username clickable
  authorName.addEventListener("click", (e) => {
    e.stopPropagation();
    console.log("Username clicked for UID:", idea.uid);
    if (idea.uid) {
      openProfileTab(idea.uid);
    } else {
      alert("No user ID available");
    }
  });
  authorDiv.appendChild(authorName);

  if(idea.uid===ADMIN_UID){
    const devBadge=document.createElement("span"); 
    devBadge.className="devBadge"; 
    devBadge.textContent="Developer"; 
    authorDiv.appendChild(devBadge);
  }
  card.appendChild(authorDiv);

  const descDiv = document.createElement("div"); 
  descDiv.className="markdown-body"; 
  descDiv.innerHTML = markdownToHTML(idea.description || ""); 
  card.appendChild(descDiv);

  // Reactions
  const reactBtn = document.createElement("button"); 
  reactBtn.className="reactBtn"; 
  reactBtn.textContent="â™¥ "+getTotalReactions(idea.reactions); 
  card.appendChild(reactBtn);
  
  // Save/Unsave button
  const savedIds = (currentUserProfile?.savedPosts)||[];
  const isSaved = Array.isArray(savedIds) && savedIds.includes(idea.id);
  const saveBtn = document.createElement("button");
  saveBtn.className = isSaved ? "secondary" : "";
  saveBtn.style.marginLeft = "0.5rem";
  saveBtn.textContent = isSaved ? "Saved" : "Save";
  saveBtn.title = isSaved ? "Remove from Saved" : "Save for later";
  saveBtn.addEventListener("click", async (e)=>{
    e.stopPropagation();
    if (!auth.currentUser) { alert("Sign in to save posts"); return; }
    try {
      const ref = doc(db, "profiles", auth.currentUser.uid);
      if (isSaved) {
        await updateDoc(ref, { savedPosts: arrayRemove(idea.id) });
      } else {
        await updateDoc(ref, { savedPosts: arrayUnion(idea.id) });
      }
      await refreshCurrentUserProfile();
      if (document.getElementById("navSaved")?.classList.contains("active")) {
        renderSavedIdeas();
      } else {
        renderAllIdeas();
      }
    } catch (err) {
      console.error("Error toggling save:", err);
      alert("Error updating saved posts: " + err.message);
    }
  });
  card.appendChild(saveBtn);
  
  const reactionMenu = document.createElement("div"); 
  reactionMenu.className="reactionMenu";
  ["â¤ï¸","ðŸ˜‚","ðŸ‘","ðŸŽ‰","ðŸ˜®","ðŸ˜¢","ðŸ‘Ž"].forEach(emoji=>{
    const btn=document.createElement("button"); 
    btn.textContent=emoji; 
    btn.title=`React with ${emoji}`;
    btn.addEventListener("click", async e=>{
      e.stopPropagation();
      if(!auth.currentUser)return alert("Sign in to react!");
      const ref=doc(db,"ideas",idea.id); 
      const userUid=auth.currentUser.uid;
      const arr = idea.reactions?.[emoji]||[]; 
      const hasReacted=arr.includes(userUid);
      try {
        if(hasReacted) {
          await updateDoc(ref,{ [`reactions.${emoji}`]: arrayRemove(userUid) });
        } else {
          await updateDoc(ref,{ [`reactions.${emoji}`]: arrayUnion(userUid) });
        }
      } catch (err) {
        console.error("Reaction update failed:", err);
        alert((err && err.message) ? err.message : "Failed to update reaction. Check Firestore rules to allow updating reactions.");
      }
    }); 
    reactionMenu.appendChild(btn);
  });
  card.appendChild(reactionMenu);
  
  reactBtn.addEventListener("click", e=>{
    e.stopPropagation();
    if(currentReactionMenu && currentReactionMenu!==reactionMenu) {
      currentReactionMenu.style.display="none";
    }
    reactionMenu.style.display = reactionMenu.style.display==="flex"?"none":"flex";
    currentReactionMenu = reactionMenu.style.display==="flex"?reactionMenu:null;
  });

  const reactionsDisplay=document.createElement("div"); 
  reactionsDisplay.className="reactionsDisplay";
  reactionsDisplay.textContent = Object.entries(idea.reactions||{})
    .filter(([e,a])=>Array.isArray(a) && a.length>0)
    .map(([e,a])=>`${e} ${a.length}`)
    .join("  ");
  card.appendChild(reactionsDisplay);

     // Comments container
   const commentsContainer = document.createElement("div");
   commentsContainer.style.marginTop = "1rem";
   commentsContainer.style.borderTop = "1px solid #e5e7eb";
   commentsContainer.style.paddingTop = "0.7rem";
   
   const commentsDiv = document.createElement("div");
   commentsDiv.className = "comments";
   commentsDiv.style.maxHeight = "180px";
   commentsDiv.style.overflowY = "auto";
   commentsDiv.style.marginBottom = "0.5rem";

   (idea.comments || []).forEach(c => {
    const cmnt = document.createElement("div");
    cmnt.className = "comment";

    const img = document.createElement("img");
    const commentProfile = c.uid ? (profilesCache.get(c.uid) || null) : null;
    const commentAvatarSrc = commentProfile ? getAvatarSrcFromProfile(commentProfile) : (c.avatar || "https://www.gravatar.com/avatar?d=mp&f=y");
    img.src = commentAvatarSrc;
    img.alt = ((commentProfile?.displayName) || c.author || "Anonymous") + " avatar";
    applyFrameClass(img, commentProfile);
    img.style.cursor = "pointer";
    img.addEventListener("click", (e) => {
      e.stopPropagation();
      if (c.uid) {
        openProfileTab(c.uid);
      }
    });
    cmnt.appendChild(img);

    const textContainer = document.createElement("div");
    textContainer.style.display = "flex";
    textContainer.style.flexDirection = "column";

    const nameTime = document.createElement("span");
    nameTime.className = "comment-author";
    nameTime.style.fontWeight = "600";
    nameTime.style.fontSize = "0.85rem";
    nameTime.style.color = "#4b5563";
    nameTime.style.cursor = "pointer";
    const time = c.created ? new Date(c.created).toLocaleString() : "";
    const displayName = (commentProfile?.displayName) || c.author || "Anonymous";
    nameTime.textContent = `${displayName} ${time ? "â€¢ " + time : ""}`;
    nameTime.addEventListener("click", (e) => {
      e.stopPropagation();
      if (c.uid) {
        openProfileTab(c.uid);
      }
    });
    textContainer.appendChild(nameTime);

    const commentText = document.createElement("span");
    commentText.className = "comment-text";
    commentText.innerHTML = markdownToHTML(c.text || "");
    textContainer.appendChild(commentText);

    cmnt.appendChild(textContainer);

    if (c.uid === ADMIN_UID) {
      const devBadge = document.createElement("span");
      devBadge.className = "devBadge";
      devBadge.textContent = "Developer";
      cmnt.appendChild(devBadge);
    }

         commentsDiv.appendChild(cmnt);
   });
   
   commentsContainer.appendChild(commentsDiv);

   if (auth.currentUser) {
     const commentInput = document.createElement("input");
     commentInput.placeholder = "Add a comment...";
     commentInput.style.width = "100%";
     commentInput.style.padding = "0.6rem 0.9rem";
     commentInput.style.marginTop = "0.5rem";
     commentInput.style.borderRadius = "8px";
     commentInput.style.border = "2px solid #d1d5db";
     commentInput.style.fontSize = "1rem";
     commentInput.style.fontWeight = "500";
     commentInput.style.transition = "border-color .3s ease";
     commentInput.addEventListener("focus", () => {
       commentInput.style.borderColor = "var(--primary)";
       commentInput.style.outline = "none";
       commentInput.style.boxShadow = "0 0 6px var(--primary-light)";
     });
     commentInput.addEventListener("blur", () => {
       commentInput.style.borderColor = "#d1d5db";
       commentInput.style.boxShadow = "none";
     });
     commentInput.addEventListener("keypress", async e => {
       if (e.key === "Enter" && commentInput.value.trim()) {
         try {
           const ref = doc(db, "ideas", idea.id);
           await updateDoc(ref, {
             comments: arrayUnion({
               text: commentInput.value.trim(),
               author: auth.currentUser.displayName,
               avatar: auth.currentUser.photoURL,
               uid: auth.currentUser.uid,
               created: new Date().toISOString()
             })
           });
           commentInput.value = "";
         } catch (err) {
           alert("Error adding comment: " + err.message);
         }
       }
     });
     commentsContainer.appendChild(commentInput);
   }

   card.appendChild(commentsContainer);

  if(isAdmin){
    const delBtn=document.createElement("button"); 
    delBtn.className="danger"; 
    delBtn.textContent="Delete Post";
    delBtn.addEventListener("click", async ()=>{ 
      if(confirm("Delete this post?")) {
        try {
          await deleteDoc(doc(db,"ideas",idea.id));
        } catch (err) {
          alert("Error deleting post: " + err.message);
        }
      }
    }); 
    card.appendChild(delBtn);
  }

  if (ideasList) {
    ideasList.appendChild(card);
  }
}

function markdownToHTML(md){ 
  if (!md) return "";
  return md
    .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
    .replace(/\*(.*?)\*/g,'<i>$1</i>')
    .replace(/\n/g, '<br>');
}

function formatDate(d){ 
  if (!d) return "";
  try {
    d = d?.toDate ? d.toDate() : new Date(d); 
    return d.toLocaleString(); 
  } catch (e) {
    return "Unknown date";
  }
}

function getTotalReactions(reactions){ 
  if (!reactions) return 0;
  return Object.values(reactions).reduce((a,v)=>a+(Array.isArray(v)?v.length:0),0); 
}

// Close reaction menu when clicking outside
document.addEventListener("click", (e) => {
  if(currentReactionMenu && !currentReactionMenu.contains(e.target)){ 
    const reactBtns = document.querySelectorAll(".reactBtn");
    let clickedReactBtn = false;
    reactBtns.forEach(btn => {
      if (btn.contains(e.target)) clickedReactBtn = true;
    });
    if (!clickedReactBtn) {
      currentReactionMenu.style.display="none"; 
      currentReactionMenu=null; 
    }
  } 
});
</script>
</body>
</html>
